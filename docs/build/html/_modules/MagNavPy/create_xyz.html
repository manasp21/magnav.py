<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>magnavpy.create_xyz &#8212; MagNavPy 0.1.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=5ecbeea2" />
    <link rel="stylesheet" type="text/css" href="../../_static/basic.css?v=b08954a9" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=73454398" />
    <script src="../../_static/documentation_options.js?v=01f34227"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  <div class="document">
    
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">MagNavPy</a></h1>






<p>
<iframe src="https://ghbtns.com/github-btn.html?user=manasp21&repo=magnav.py&type=star&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






<search id="searchbox" style="display: none" role="search">
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" placeholder="Search"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script><h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">Flight Path &amp; INS Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../maps.html">Magnetic Anomaly Maps</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../comp.html">Aeromagnetic Compensation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nncomp.html">Neural Network-Based Model Diagrams</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nav.html">Navigation Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../status.html">Current Status and Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_functions.html">API: Functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_structs.html">API: Structs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_reference.html">API Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>








        </div>
      </div>
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for magnavpy.create_xyz</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module is responsible for creating and initializing XYZ data objects,</span>
<span class="sd">and handling XYZ text file input/output.</span>
<span class="sd">Translated and extended from the Julia MagNav.jl/src/create_XYZ.jl.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">h5py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">random</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span> <span class="c1"># Added for accessing patched constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">importlib</span> <span class="c1"># Added for reloading constants</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats</span><span class="w"> </span><span class="kn">import</span> <span class="n">multivariate_normal</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.common_types</span><span class="w"> </span><span class="kn">import</span> <span class="n">MapS</span> <span class="k">as</span> <span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">MapSd</span> <span class="k">as</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">MapS3D</span> <span class="k">as</span> <span class="n">_ActualMapS3D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">constants</span> <span class="c1"># Import constants module</span>

<span class="c1"># Define map_check locally as it seems to be missing from analysis_util</span>
<span class="c1"># Based on its usage and the fallback definition.</span>
<div class="viewcode-block" id="map_check">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.map_check">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">map_check</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">la</span><span class="p">,</span> <span class="n">lo</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the given latitude/longitude path is valid on the map.&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation, always returns True.</span>
    <span class="c1"># TODO: Implement actual map boundary/validity checks if necessary.</span>
    <span class="k">return</span> <span class="kc">True</span></div>


<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Traj</span><span class="p">:</span>
    <span class="n">N</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">tt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">lat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">lon</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">alt</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">ve</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">vd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">fn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">fe</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">fd</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">Cnb</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MagV</span><span class="p">:</span>
    <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">z</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">t</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<div class="viewcode-block" id="utm_zone_from_latlon">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.utm_zone_from_latlon">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">utm_zone_from_latlon</span><span class="p">(</span><span class="n">lat_deg</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lon_deg</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates UTM zone number and hemisphere.&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation from fallback block.</span>
    <span class="c1"># TODO: Consider using a more robust UTM library if precision is critical.</span>
    <span class="k">return</span> <span class="p">(</span><span class="nb">int</span><span class="p">((</span><span class="n">lon_deg</span> <span class="o">+</span> <span class="mi">180</span><span class="p">)</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lat_deg</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span></div>


<div class="viewcode-block" id="transform_lla_to_utm">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.transform_lla_to_utm">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">transform_lla_to_utm</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">lon_rad</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">zone</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">is_north</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Converts LLA to UTM coordinates (placeholder).&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation from fallback block.</span>
    <span class="c1"># TODO: Implement actual LLA to UTM conversion or use a library.</span>
    <span class="n">lat_deg</span><span class="p">,</span> <span class="n">lon_deg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">lon_rad</span><span class="p">)</span> <span class="c1"># Corrected rad2rad to rad2deg</span>
    <span class="k">return</span> <span class="n">lon_deg</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">lat_deg</span> <span class="o">*</span> <span class="mi">1000</span> <span class="c1"># Simplified placeholder</span></div>


<div class="viewcode-block" id="create_dcm_from_vel">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_dcm_from_vel">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_dcm_from_vel</span><span class="p">(</span><span class="n">vn</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ve</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates an array of DCMs from velocity (placeholder).&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation from fallback block.</span>
    <span class="c1"># TODO: Implement actual DCM creation logic.</span>
    <span class="n">N_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
    <span class="c1"># Stack identity matrices along the third axis</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span> <span class="o">*</span> <span class="n">N_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># Returns (3, 3, N)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">get_tolles_lawson_aircraft_field_vector</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">Bt_scale</span><span class="p">,</span>
                                            <span class="n">flux_c</span><span class="p">,</span> <span class="n">norm_flux_a</span><span class="p">,</span> <span class="n">norm_flux_b</span><span class="p">,</span> <span class="n">norm_flux_c</span><span class="p">,</span> <span class="n">dcm_data</span><span class="p">,</span> <span class="n">igrf_bf</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># Added missing args and kwargs</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Local placeholder for get_tolles_lawson_aircraft_field_vector.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ: Using placeholder get_tolles_lawson_aircraft_field_vector&quot;</span><span class="p">)</span>
    <span class="c1"># Original placeholder logic:</span>
    <span class="c1"># return (np.zeros((3,3)), np.zeros((3,3)), np.zeros((3,3)))</span>
    <span class="c1"># The function in Julia returns a 3xN array, so let&#39;s return something like that.</span>
    <span class="c1"># Determine N from one of the inputs if possible, e.g., flux_c.shape[1] or dcm_data.shape[0]</span>
    <span class="c1"># For now, a generic placeholder:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dcm_data</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dcm_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">dcm_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># dcm_data might be N x 3 x 3, ensure N is not 1 from a scalar-like input</span>
         <span class="n">N</span> <span class="o">=</span> <span class="n">dcm_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">flux_c</span><span class="p">,</span> <span class="s1">&#39;shape&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">flux_c</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">flux_c</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">N</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Default if N cannot be determined</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
<div class="viewcode-block" id="create_ins_model_matrices">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_ins_model_matrices">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_ins_model_matrices</span><span class="p">(</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">std_acc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">std_gyro</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                <span class="n">tau_acc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tau_gyro</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                <span class="c1"># traj_data_dict: Optional[Dict[str, Any]] = None, # Commented out if not used</span>
                                <span class="c1"># ins_options: Optional[Dict[str, Any]] = None,   # Commented out if not used</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span> <span class="c1"># Added **kwargs</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates placeholder INS model matrices P0, Qd, R.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Using placeholder create_ins_model_matrices, received kwargs: </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="c1"># Log kwargs</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="mi">17</span> <span class="c1"># Changed from 9 to 17</span>
    <span class="n">P0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span>
    <span class="n">Qd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.01</span>
    <span class="c1"># The third element (R, measurement noise covariance) can remain None if not immediately problematic</span>
    <span class="c1"># or be a placeholder like np.eye(num_measurements) if its absence causes issues later.</span>
    <span class="c1"># For now, returning None as per the original structure for the third element.</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">P0</span><span class="p">,</span> <span class="n">Qd</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="c1"># Return placeholder matrices</span></div>

<span class="k">def</span><span class="w"> </span><span class="nf">trim_map</span><span class="p">(</span><span class="n">map_obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">lat_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lon_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">alt_array</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
             <span class="n">buffer</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">is_lla</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Placeholder for trim_map function.</span>
<span class="sd">    This function is intended to trim a map object to the extents of a given path.</span>
<span class="sd">    Currently, it returns the original map object unmodified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: trim_map called with map_obj type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">map_obj</span><span class="p">)</span><span class="si">}</span><span class="s2">. Returning unmodified map.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">map_obj</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">17</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span> <span class="c1"># P0, Qd, R (dummy R)</span>

<div class="viewcode-block" id="get_phi_matrix">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.get_phi_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_phi_matrix</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a placeholder Phi matrix.&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation from fallback block.</span>
    <span class="c1"># TODO: Implement actual Phi matrix calculation.</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span></div>


<div class="viewcode-block" id="correct_cnb_matrix">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.correct_cnb_matrix">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">correct_cnb_matrix</span><span class="p">(</span><span class="n">cnb</span><span class="p">,</span> <span class="n">err</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Corrects Cnb matrix with given error (placeholder).&quot;&quot;&quot;</span>
    <span class="c1"># Placeholder implementation, returns original Cnb.</span>
    <span class="c1"># TODO: Implement actual Cnb correction if needed.</span>
    <span class="k">return</span> <span class="n">cnb</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">upward_fft_map</span><span class="p">(</span><span class="n">map_s</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">alt</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span> <span class="c1"># Based on fallback, added type hints</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Placeholder for upward_fft_map.</span>
<span class="sd">    Performs upward continuation using FFT (currently a placeholder).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># print(f&quot;DEBUG_CREATE_XYZ: upward_fft_map called with map_s type {type(map_s)}, alt {alt}&quot;)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="s1">&#39;map&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">callable</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="s1">&#39;copy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)):</span> <span class="c1"># Check if copy is callable</span>
         <span class="c1"># Attempt deepcopy if possible, otherwise shallow copy or original</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_map_s</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">map_s</span><span class="p">)</span>
            <span class="c1"># Placeholder: actual upward continuation logic would modify new_map_s.map</span>
            <span class="c1"># e.g., new_map_s.map = perform_fft_continuation(new_map_s.map, getattr(new_map_s, &#39;alt&#39;, alt), alt)</span>
            <span class="k">return</span> <span class="n">new_map_s</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="c1"># deepcopy might fail for some complex types not designed for it</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">map_s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">map_s</span> <span class="c1"># Return original if no copy mechanism</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="s1">&#39;copy&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">map_s</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># If it&#39;s just a numpy array</span>
    <span class="k">return</span> <span class="n">map_s</span> <span class="c1"># Fallback for simple data or if no copy attribute</span>

<div class="viewcode-block" id="get_map_params">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.get_map_params">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_map_params</span><span class="p">(</span><span class="n">map_s</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Placeholder for get_map_params. Returns dummy indices.&quot;&quot;&quot;</span>
    <span class="c1"># Based on fallback: ind0, ind1, _, _</span>
    <span class="c1"># print(f&quot;DEBUG_CREATE_XYZ: get_map_params called with map_s type {type(map_s)}&quot;)</span>
    <span class="k">return</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">fill_map_gaps</span><span class="p">(</span><span class="n">map_s</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Placeholder for fill_map_gaps. Returns the map as is.&quot;&quot;&quot;</span>
    <span class="c1"># print(f&quot;DEBUG_CREATE_XYZ: fill_map_gaps called with map_s type {type(map_s)}&quot;)</span>
    <span class="c1"># In a real implementation, this would fill gaps in the map data.</span>
    <span class="k">return</span> <span class="n">map_s</span>
<span class="k">def</span><span class="w"> </span><span class="nf">apply_band_pass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lowcut</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">highcut</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">fs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">order</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Placeholder for apply_band_pass_filter. Returns original data.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Using placeholder apply_band_pass_filter for data of shape </span><span class="si">{</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># In a real implementation, this would apply a band-pass filter.</span>
    <span class="c1"># For now, it returns the data unmodified.</span>
    <span class="k">return</span> <span class="n">data</span>
<span class="c1"># Attempt to import from project modules</span>

<span class="c1"># Define generate_fogm_noise locally as a placeholder</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_fogm_noise</span><span class="p">(</span><span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates placeholder First-Order Gauss-Markov (FOGM) noise.</span>
<span class="sd">    This is a simplified placeholder.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Using placeholder generate_fogm_noise (sigma=</span><span class="si">{</span><span class="n">sigma</span><span class="si">}</span><span class="s2">, tau=</span><span class="si">{</span><span class="n">tau</span><span class="si">}</span><span class="s2">, dt=</span><span class="si">{</span><span class="n">dt</span><span class="si">}</span><span class="s2">, N=</span><span class="si">{</span><span class="n">N</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="c1"># Simple random noise, not true FOGM, for placeholder purposes</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span>

<span class="c1"># Define create_tolles_lawson_A_matrix locally as a placeholder</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_tolles_lawson_A_matrix</span><span class="p">(</span><span class="n">Bx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">By</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">Bz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a placeholder Tolles-Lawson A matrix.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG: Using placeholder create_tolles_lawson_A_matrix (Bx_shape=</span><span class="si">{</span><span class="n">Bx</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">, terms=</span><span class="si">{</span><span class="n">terms</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
    <span class="c1"># Determine number of terms (columns). Default to 18 if terms not specified or standard.</span>
    <span class="c1"># This matches the fallback definition&#39;s shape.</span>
    <span class="n">num_terms</span> <span class="o">=</span> <span class="mi">18</span> <span class="c1"># Common number of terms for Tolles-Lawson</span>
    <span class="k">if</span> <span class="n">terms</span><span class="p">:</span>
        <span class="c1"># A more sophisticated approach might adjust num_terms based on the &#39;terms&#39; list.</span>
        <span class="c1"># For a simple placeholder, we can stick to a fixed size or a simple rule.</span>
        <span class="c1"># For now, keeping it fixed to 18 as per the original fallback.</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Bx</span><span class="p">),</span> <span class="n">num_terms</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">norm_igrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_xyz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Local placeholder for get_igrf_magnetic_field.&quot;&quot;&quot;</span>
    <span class="c1"># This definition is based on the fallback from the except ImportError block.</span>
    <span class="n">num_points</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># Default if determination fails</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="s1">&#39;traj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="s1">&#39;lat&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xyz</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not determine num_points from xyz.traj.lat or ind in get_igrf_magnetic_field. Defaulting to </span><span class="si">{</span><span class="n">num_points</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">ind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not determine num_points from ind in get_igrf_magnetic_field. Defaulting to </span><span class="si">{</span><span class="n">num_points</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">pass</span>
    <span class="c1"># If xyz.N is a reliable source for number of points, it could be added as another elif.</span>
    <span class="c1"># else:</span>
    <span class="c1">#     print(f&quot;Warning: xyz.traj.lat not available and ind is None in get_igrf_magnetic_field. Defaulting to {num_points}.&quot;)</span>

    <span class="k">if</span> <span class="n">norm_igrf</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_points</span><span class="p">))</span>

<span class="c1"># Placeholder for get_trajectory_subset, moved from except block and enhanced</span>
<div class="viewcode-block" id="get_trajectory_subset">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.get_trajectory_subset">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">get_trajectory_subset</span><span class="p">(</span><span class="n">traj</span><span class="p">:</span> <span class="s1">&#39;Traj&#39;</span><span class="p">,</span> <span class="n">ind</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;Traj&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simplified placeholder for get_trajectory_subset.&quot;&quot;&quot;</span>
    <span class="c1"># Ensure indices are suitable for numpy array indexing</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Indices must be a list or numpy array, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ind</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> <span class="c1"># Convert list to numpy array if necessary</span>
        <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
    
    <span class="c1"># Placeholder: Actual Traj class might be imported later or defined in except block</span>
    <span class="c1"># This structure assumes Traj has these attributes and they are indexable.</span>
    <span class="c1"># A more robust placeholder might need to check for attribute existence.</span>
    <span class="c1"># For simplicity, direct attribute access is used here.</span>
    <span class="c1"># Also, Cnb might need special handling if it can be empty or not always present.</span>
    <span class="n">cnb_data</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="s1">&#39;Cnb&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># Create a new Traj-like object. If Traj is a dataclass, this is straightforward.</span>
    <span class="c1"># If not, this might need to be adjusted based on Traj&#39;s actual constructor.</span>
    <span class="c1"># Assuming a constructor or that a simple object with attributes is sufficient for placeholder.</span>
    <span class="c1"># For now, returning a dictionary, assuming it will be converted to Traj or used as such.</span>
    <span class="c1"># This part might need refinement based on how Traj is actually used with the subset.</span>
    <span class="c1"># For a true placeholder, we might need to define a dummy Traj class if not available.</span>
    
    <span class="c1"># Reverting to direct instantiation if Traj is known (e.g. from .magnav import)</span>
    <span class="c1"># The type hint &#39;Traj&#39; will refer to the imported or dummy Traj class.</span>
    <span class="k">return</span> <span class="n">Traj</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">),</span> <span class="n">dt</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">tt</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">lat</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">lon</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">lon</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">alt</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">alt</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                <span class="n">vn</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">vn</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ve</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">ve</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">vd</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">vd</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">fn</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">fn</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">fe</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">fe</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">fd</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">fd</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                <span class="n">Cnb</span><span class="o">=</span><span class="n">cnb_data</span><span class="p">)</span></div>


<span class="k">def</span><span class="w"> </span><span class="nf">tolles_lawson_coeffs_to_matrix</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">Bt_scale</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Local placeholder for tolles_lawson_coeffs_to_matrix.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ: Using placeholder tolles_lawson_coeffs_to_matrix&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.map_utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_map_val</span><span class="p">,</span> <span class="n">get_map</span> <span class="c1"># Correctly import get_map from map_utils</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.magnav</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span><span class="n">XYZ0</span><span class="p">,</span> <span class="n">Traj</span><span class="p">,</span> <span class="n">INS</span><span class="p">,</span> <span class="n">MagV</span><span class="p">,</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">,</span> <span class="n">MapV</span><span class="p">,</span>
                            <span class="n">Map</span><span class="p">,</span> <span class="n">Path</span><span class="p">,</span> <span class="n">add_extension</span><span class="p">,</span> <span class="n">G_EARTH</span><span class="p">)</span> <span class="c1"># Added G_EARTH</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.analysis_util</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span> <span class="c1"># Removed get_tolles_lawson_aircraft_field_vector</span>
        <span class="n">dlat2dn</span><span class="p">,</span> <span class="n">dlon2de</span><span class="p">,</span> <span class="n">dn2dlat</span><span class="p">,</span> <span class="c1"># Removed map_check, g_earth, AND get_map</span>
        <span class="n">de2dlon</span><span class="p">,</span> <span class="n">fdm</span><span class="p">,</span> <span class="c1"># Removed utm_zone_from_latlon, transform_lla_to_utm</span>
        <span class="n">dcm2euler</span><span class="p">,</span> <span class="n">euler2dcm</span><span class="p">,</span> <span class="c1"># Removed create_dcm_from_vel</span>
        <span class="c1"># trim_map, # Removed upward_fft_map, get_map_params, fill_map_gaps - trim_map is defined locally</span>
        <span class="c1"># generate_fogm_noise, # Removed import, defined locally</span>
        <span class="c1"># create_tolles_lawson_A_matrix, # Removed import, defined locally</span>
        <span class="c1"># get_band_pass_filter_coeffs, # Removed import, already defined locally</span>
        <span class="c1"># get_tolles_lawson_aircraft_field_vector, # Commented out to resolve ImportError</span>
        <span class="c1"># get_trajectory_subset, # Now defined locally as a placeholder</span>
        <span class="c1"># approximate_gradient # Removed import, will be defined locally as placeholder</span>
    <span class="p">)</span>
    <span class="c1"># Default map identifiers will now be accessed via constants module</span>
    <span class="c1"># DEFAULT_SCALAR_MAP_ID = &quot;namad&quot; # Placeholder</span>
    <span class="c1"># DEFAULT_VECTOR_MAP_ID = &quot;emm720&quot; # Placeholder</span>

<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="c1"># Fallback for standalone execution or if modules are structured differently</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ERROR_DEBUG: An ImportError occurred in create_xyz.py. Falling back to dummy implementations.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR_DEBUG: Specific import error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: Could not import from .magnav or .analysis_util. Placeholder types and functions will be used.&quot;</span><span class="p">)</span>
    <span class="c1"># Define dummy classes and functions if needed for linting/testing without full project</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">BaseMap</span><span class="p">:</span> <span class="k">pass</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">MapS</span><span class="p">(</span><span class="n">BaseMap</span><span class="p">):</span> <span class="n">xx</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">yy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="nb">map</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">alt</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">MapSd</span><span class="p">(</span><span class="n">MapS</span><span class="p">):</span> <span class="n">mask</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">MapS3D</span><span class="p">(</span><span class="n">MapS</span><span class="p">):</span> <span class="n">zz</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">;</span> <span class="n">alt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># alt might be 3D grid</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">MapV</span><span class="p">(</span><span class="n">BaseMap</span><span class="p">):</span><span class="k">pass</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">INS</span><span class="p">(</span><span class="n">Traj</span><span class="p">):</span> <span class="n">P</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="c1"># Covariance matrices</span>
    <span class="nd">@dataclass</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">XYZ0</span><span class="p">:</span> <span class="n">info</span><span class="p">:</span> <span class="nb">str</span><span class="p">;</span> <span class="n">traj</span><span class="p">:</span> <span class="n">Traj</span><span class="p">;</span> <span class="n">ins</span><span class="p">:</span> <span class="n">INS</span><span class="p">;</span> <span class="n">flux_a</span><span class="p">:</span> <span class="n">MagV</span><span class="p">;</span> <span class="n">flights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">lines</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">years</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">doys</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">diurnal</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">igrf</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">mag_1_c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">;</span> <span class="n">mag_1_uc</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">Path</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Traj</span><span class="p">,</span> <span class="n">INS</span><span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_extension</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span> <span class="k">return</span> <span class="n">s</span> <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">ext</span><span class="p">)</span> <span class="k">else</span> <span class="n">s</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">G_EARTH</span> <span class="o">=</span> <span class="mf">9.80665</span> <span class="c1"># Changed to G_EARTH</span>
    <span class="c1"># def get_map(map_id, **kwargs): return MapS(xx=np.array([]), yy=np.array([]), map=np.array([])) # Dummy, accepts **kwargs to prevent TypeError - COMMENTED OUT TO USE IMPORTED VERSION</span>
    <span class="c1"># DEFAULT_SCALAR_MAP_ID = &quot;namad&quot; # Accessed via constants</span>
    <span class="c1"># DEFAULT_VECTOR_MAP_ID = &quot;emm720&quot; # Accessed via constants</span>
    <span class="c1"># def map_check(m,la,lo): return True # Moved to main scope</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dlat2dn</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span> <span class="k">return</span> <span class="n">dlat</span> <span class="o">*</span> <span class="mi">111000</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dlon2de</span><span class="p">(</span><span class="n">dlon</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span> <span class="k">return</span> <span class="n">dlon</span> <span class="o">*</span> <span class="mi">111000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dn2dlat</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span> <span class="k">return</span> <span class="n">dn</span> <span class="o">/</span> <span class="mi">111000</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">de2dlon</span><span class="p">(</span><span class="n">de</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span> <span class="k">return</span> <span class="n">de</span> <span class="o">/</span> <span class="p">(</span><span class="mi">111000</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">fdm</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span> <span class="k">if</span> <span class="n">arr</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
    <span class="c1"># def utm_zone_from_latlon(lat_deg, lon_deg): return (int((lon_deg + 180) / 6) + 1, lat_deg &gt;=0) # Moved to main scope</span>
    <span class="c1"># def transform_lla_to_utm(lat_rad, lon_rad, zone, is_north): # Moved to main scope</span>
    <span class="c1">#     lat_deg, lon_deg = np.rad2deg(lat_rad), np.rad2deg(lon_rad)</span>
    <span class="c1">#     return lon_deg * 1000, lat_deg * 1000</span>
    <span class="c1"># def create_dcm_from_vel(vn, ve, dt, order): return np.array([np.eye(3)] * len(vn)) # Moved to main scope</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dcm2euler</span><span class="p">(</span><span class="n">dcm</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">dcm</span><span class="p">),</span> <span class="mi">3</span><span class="p">))</span> <span class="k">if</span> <span class="n">dcm</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">euler2dcm</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span><span class="n">pitch</span><span class="p">,</span><span class="n">yaw</span><span class="p">,</span><span class="n">order</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">roll</span><span class="p">))</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="c1"># def create_ins_model_matrices(*args, **kwargs): return np.eye(17), np.eye(17), np.eye(17) # Moved to main scope</span>
    <span class="c1"># def get_phi_matrix(*args, **kwargs): return np.eye(17) # Moved to main scope</span>
<div class="viewcode-block" id="upward_fft_map">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.upward_fft_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">upward_fft_map</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="n">alt</span><span class="p">):</span> <span class="k">return</span> <span class="n">map_s</span></div>

    <span class="c1"># def get_map_params(map_s): return (None,None,None,None) # Moved to main scope</span>
<div class="viewcode-block" id="fill_map_gaps">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.fill_map_gaps">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">fill_map_gaps</span><span class="p">(</span><span class="n">map_s</span><span class="p">):</span> <span class="k">return</span> <span class="n">map_s</span></div>

<div class="viewcode-block" id="trim_map">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.trim_map">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">trim_map</span><span class="p">(</span><span class="n">map_s</span><span class="p">):</span> <span class="k">return</span> <span class="n">map_s</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_map_val</span><span class="p">(</span><span class="n">map_s</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">alt</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">return_interpolator</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">return_interpolator</span><span class="p">:</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">)),</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lat</span><span class="p">))</span>
<div class="viewcode-block" id="generate_fogm_noise">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.generate_fogm_noise">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_fogm_noise</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span></div>

<div class="viewcode-block" id="create_tolles_lawson_A_matrix">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_tolles_lawson_A_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_tolles_lawson_A_matrix</span><span class="p">(</span><span class="n">Bx</span><span class="p">,</span><span class="n">By</span><span class="p">,</span><span class="n">Bz</span><span class="p">,</span><span class="n">terms</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">Bx</span><span class="p">),</span> <span class="mi">18</span><span class="p">))</span> <span class="c1"># Dummy</span></div>

<div class="viewcode-block" id="get_igrf_magnetic_field">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.get_igrf_magnetic_field">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">ind</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">norm_igrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_xyz</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xyz</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_points</span><span class="p">))</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">norm_igrf</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span></div>

<div class="viewcode-block" id="apply_band_pass_filter">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.apply_band_pass_filter">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">apply_band_pass_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">bpf_coeffs</span><span class="p">):</span> <span class="k">return</span> <span class="n">data</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_band_pass_filter_coeffs</span><span class="p">(</span><span class="n">pass1</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span><span class="n">pass2</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span> <span class="k">return</span> <span class="kc">None</span>
<div class="viewcode-block" id="tolles_lawson_coeffs_to_matrix">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.tolles_lawson_coeffs_to_matrix">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">tolles_lawson_coeffs_to_matrix</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">Bt_scale</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)))</span></div>

<div class="viewcode-block" id="get_tolles_lawson_aircraft_field_vector">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.get_tolles_lawson_aircraft_field_vector">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tolles_lawson_aircraft_field_vector</span><span class="p">(</span><span class="n">B_earth</span><span class="p">,</span> <span class="n">B_earth_dot</span><span class="p">,</span> <span class="n">c_p</span><span class="p">,</span> <span class="n">c_i</span><span class="p">,</span> <span class="n">c_e</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">B_earth</span><span class="p">)</span></div>

    <span class="c1"># def get_trajectory_subset(traj, ind): # Simplified # Removed as it&#39;s defined globally now</span>
    <span class="c1">#     return Traj(N=len(ind), dt=traj.dt, tt=traj.tt[ind], lat=traj.lat[ind], lon=traj.lon[ind], alt=traj.alt[ind],</span>
    <span class="c1">#                 vn=traj.vn[ind], ve=traj.ve[ind], vd=traj.vd[ind], fn=traj.fn[ind], fe=traj.fe[ind], fd=traj.fd[ind],</span>
    <span class="c1">#                 Cnb=traj.Cnb[ind])</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">approximate_gradient</span><span class="p">(</span><span class="n">itp_func</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span> <span class="c1"># Dummy</span>

<div class="viewcode-block" id="approximate_gradient">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.approximate_gradient">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">approximate_gradient</span><span class="p">(</span><span class="n">itp_func</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Local placeholder for approximate_gradient.&quot;&quot;&quot;</span>
    <span class="c1"># This definition is based on the fallback from the except ImportError block,</span>
    <span class="c1"># now made globally available as its import is removed from the try block.</span>
    <span class="c1"># print(f&quot;DEBUG_CREATE_XYZ: Using global placeholder approximate_gradient&quot;)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span> <span class="c1"># Dummy</span></div>



<div class="viewcode-block" id="create_xyz0">
<a class="viewcode-back" href="../../data.html#magnavpy.create_xyz.create_xyz0">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_xyz0</span><span class="p">(</span>
    <span class="n">mapS</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">,</span>
    <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">68.0</span><span class="p">,</span>
    <span class="n">ll1</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">ll2</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">N_waves</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">info</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Simulated data&quot;</span><span class="p">,</span>
    <span class="n">flight</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">line</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">year</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2023</span><span class="p">,</span>
    <span class="n">doy</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">154</span><span class="p">,</span>
    <span class="n">mapV</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MapV</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cor_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">cor_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">600.0</span><span class="p">,</span>
    <span class="n">cor_var</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">cor_drift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">cor_perm_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">cor_ind_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">cor_eddy_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">init_pos_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">init_alt_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">init_vel_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">init_att_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
    <span class="n">VRW_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.000238</span><span class="p">,</span>
    <span class="n">ARW_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.000000581</span><span class="p">,</span>
    <span class="n">baro_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">ha_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">a_hat_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">acc_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.000245</span><span class="p">,</span>
    <span class="n">gyro_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00000000727</span><span class="p">,</span>
    <span class="n">fogm_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">baro_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">acc_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">gyro_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">fogm_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">600.0</span><span class="p">,</span>
    <span class="n">save_h5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">xyz_h5</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;xyz_data.h5&quot;</span><span class="p">,</span>
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">default_scalar_map_id_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">default_vector_map_id_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XYZ0</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create basic flight data (XYZ0 struct). Assumes constant altitude (2D flight).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Fetch constants module from sys.modules to access patched values</span>
    <span class="n">constants_module</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;magnavpy.constants&#39;</span><span class="p">,</span> <span class="n">constants</span><span class="p">)</span> <span class="c1"># Fallback to imported if not in sys.modules</span>
    
    <span class="c1"># Determine scalar map ID to use</span>
    <span class="k">if</span> <span class="n">default_scalar_map_id_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mapS_name_to_use</span> <span class="o">=</span> <span class="n">default_scalar_map_id_override</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ0: Using default_scalar_map_id_override for scalar map: &#39;</span><span class="si">{</span><span class="n">mapS_name_to_use</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mapS_name_to_use</span> <span class="o">=</span> <span class="n">constants_module</span><span class="o">.</span><span class="n">DEFAULT_SCALAR_MAP_ID</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ0: Using constants.DEFAULT_SCALAR_MAP_ID (via sys.modules) for scalar map: &#39;</span><span class="si">{</span><span class="n">mapS_name_to_use</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mapS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">map_kwargs_scalar</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># Define map_kwargs for scalar map call</span>
        <span class="c1"># Explicitly set map_type=&quot;scalar&quot; to avoid ambiguity if ID points to a vector map path</span>
        <span class="n">mapS</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">mapS_name_to_use</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="s2">&quot;scalar&quot;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span> <span class="o">**</span><span class="n">map_kwargs_scalar</span><span class="p">)</span>
    
    <span class="c1"># Determine the default_map_id_override for create_flux</span>
    <span class="c1"># This value will be the potentially patched constants.DEFAULT_VECTOR_MAP_ID</span>
    <span class="c1"># mapV_instance_for_flux will hold the MapV object if it&#39;s passed directly.</span>
    <span class="n">mapV_instance_for_flux</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MapV</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapV</span>
    
    <span class="c1"># This will be the map_id passed to create_flux if mapV_instance_for_flux is None.</span>
    <span class="n">map_id_to_pass_to_create_flux</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">mapV_instance_for_flux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># mapV was not provided as an object, so create_flux will need to load it using an ID.</span>
        <span class="k">if</span> <span class="n">default_vector_map_id_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">map_id_to_pass_to_create_flux</span> <span class="o">=</span> <span class="n">default_vector_map_id_override</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ0: mapV is None. Using default_vector_map_id_override for create_flux: &#39;</span><span class="si">{</span><span class="n">map_id_to_pass_to_create_flux</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">map_id_to_pass_to_create_flux</span> <span class="o">=</span> <span class="n">constants_module</span><span class="o">.</span><span class="n">DEFAULT_VECTOR_MAP_ID</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ0: mapV is None. Using constants.DEFAULT_VECTOR_MAP_ID (via sys.modules) for create_flux: &#39;</span><span class="si">{</span><span class="n">map_id_to_pass_to_create_flux</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
        <span class="c1"># We do NOT load mapV here; create_flux will handle it using the map_id_to_pass_to_create_flux.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_XYZ0: mapV (mapV_instance_for_flux) was provided directly. Type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">mapV_instance_for_flux</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># If mapV_instance_for_flux is provided, map_id_to_pass_to_create_flux remains None.</span>
        <span class="c1"># create_flux will use the mapV_instance_for_flux object.</span>


    <span class="n">xyz_h5</span> <span class="o">=</span> <span class="n">add_extension</span><span class="p">(</span><span class="n">xyz_h5</span><span class="p">,</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

    <span class="c1"># Create trajectory</span>
    <span class="n">traj</span> <span class="o">=</span> <span class="n">create_traj</span><span class="p">(</span>
        <span class="n">mapS</span><span class="p">,</span>
        <span class="n">alt</span><span class="o">=</span><span class="n">alt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">ll1</span><span class="o">=</span><span class="n">ll1</span><span class="p">,</span> <span class="n">ll2</span><span class="o">=</span><span class="n">ll2</span><span class="p">,</span> <span class="n">N_waves</span><span class="o">=</span><span class="n">N_waves</span><span class="p">,</span>
        <span class="n">attempts</span><span class="o">=</span><span class="n">attempts</span><span class="p">,</span> <span class="n">save_h5</span><span class="o">=</span><span class="n">save_h5</span><span class="p">,</span> <span class="n">traj_h5</span><span class="o">=</span><span class="n">xyz_h5</span>
    <span class="p">)</span>

    <span class="c1"># Create INS</span>
    <span class="n">ins</span> <span class="o">=</span> <span class="n">create_ins</span><span class="p">(</span>
        <span class="n">traj</span><span class="p">,</span>
        <span class="n">init_pos_sigma</span><span class="o">=</span><span class="n">init_pos_sigma</span><span class="p">,</span> <span class="n">init_alt_sigma</span><span class="o">=</span><span class="n">init_alt_sigma</span><span class="p">,</span>
        <span class="n">init_vel_sigma</span><span class="o">=</span><span class="n">init_vel_sigma</span><span class="p">,</span> <span class="n">init_att_sigma</span><span class="o">=</span><span class="n">init_att_sigma</span><span class="p">,</span>
        <span class="n">VRW_sigma</span><span class="o">=</span><span class="n">VRW_sigma</span><span class="p">,</span> <span class="n">ARW_sigma</span><span class="o">=</span><span class="n">ARW_sigma</span><span class="p">,</span> <span class="n">baro_sigma</span><span class="o">=</span><span class="n">baro_sigma</span><span class="p">,</span>
        <span class="n">ha_sigma</span><span class="o">=</span><span class="n">ha_sigma</span><span class="p">,</span> <span class="n">a_hat_sigma</span><span class="o">=</span><span class="n">a_hat_sigma</span><span class="p">,</span> <span class="n">acc_sigma</span><span class="o">=</span><span class="n">acc_sigma</span><span class="p">,</span>
        <span class="n">gyro_sigma</span><span class="o">=</span><span class="n">gyro_sigma</span><span class="p">,</span> <span class="n">baro_tau</span><span class="o">=</span><span class="n">baro_tau</span><span class="p">,</span> <span class="n">acc_tau</span><span class="o">=</span><span class="n">acc_tau</span><span class="p">,</span>
        <span class="n">gyro_tau</span><span class="o">=</span><span class="n">gyro_tau</span><span class="p">,</span> <span class="n">save_h5</span><span class="o">=</span><span class="n">save_h5</span><span class="p">,</span> <span class="n">ins_h5</span><span class="o">=</span><span class="n">xyz_h5</span>
    <span class="p">)</span>

    <span class="c1"># Create compensated (clean) scalar magnetometer measurements</span>
    <span class="n">mag_1_c</span> <span class="o">=</span> <span class="n">create_mag_c</span><span class="p">(</span>
        <span class="n">traj</span><span class="p">,</span> <span class="n">mapS</span><span class="p">,</span> <span class="c1"># mapS here is the map_object</span>
        <span class="n">meas_var</span><span class="o">=</span><span class="n">cor_var</span><span class="p">,</span>
        <span class="n">fogm_sigma</span><span class="o">=</span><span class="n">fogm_sigma</span><span class="p">,</span>
        <span class="n">fogm_tau</span><span class="o">=</span><span class="n">fogm_tau</span><span class="p">,</span>
        <span class="n">silent</span><span class="o">=</span><span class="n">silent</span>
    <span class="p">)</span>

    <span class="c1"># Create compensated (clean) vector magnetometer measurements</span>
    <span class="c1"># Pass mapV_instance_for_flux (which could be None or a MapV object)</span>
    <span class="c1"># and map_id_to_pass_to_create_flux (which is set if mapV_instance_for_flux is None)</span>
    <span class="n">flux_a</span> <span class="o">=</span> <span class="n">create_flux</span><span class="p">(</span>
        <span class="n">path_or_lat</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span>
        <span class="n">lon_or_mapV</span><span class="o">=</span><span class="n">mapV_instance_for_flux</span><span class="p">,</span> <span class="c1"># This can be None</span>
        <span class="n">meas_var</span><span class="o">=</span><span class="n">cor_var</span><span class="p">,</span>
        <span class="n">fogm_sigma</span><span class="o">=</span><span class="n">fogm_sigma</span><span class="p">,</span>
        <span class="n">fogm_tau</span><span class="o">=</span><span class="n">fogm_tau</span><span class="p">,</span>
        <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">,</span>
        <span class="n">default_map_id_override</span><span class="o">=</span><span class="n">map_id_to_pass_to_create_flux</span> <span class="c1"># Pass the override</span>
    <span class="p">)</span>

    <span class="c1"># Create uncompensated (corrupted) scalar magnetometer measurements</span>
    <span class="n">mag_1_uc</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">diurnal_effect</span> <span class="o">=</span> <span class="n">corrupt_mag</span><span class="p">(</span>
        <span class="n">mag_1_c</span><span class="p">,</span> <span class="n">flux_a</span><span class="p">,</span>
        <span class="n">traj_ideal</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span>
        <span class="n">cor_sigma</span><span class="o">=</span><span class="n">cor_sigma</span><span class="p">,</span> <span class="n">cor_tau</span><span class="o">=</span><span class="n">cor_tau</span><span class="p">,</span> <span class="n">cor_var</span><span class="o">=</span><span class="n">cor_var</span><span class="p">,</span>
        <span class="n">cor_drift</span><span class="o">=</span><span class="n">cor_drift</span><span class="p">,</span> <span class="n">cor_perm_mag</span><span class="o">=</span><span class="n">cor_perm_mag</span><span class="p">,</span>
        <span class="n">cor_ind_mag</span><span class="o">=</span><span class="n">cor_ind_mag</span><span class="p">,</span> <span class="n">cor_eddy_mag</span><span class="o">=</span><span class="n">cor_eddy_mag</span>
    <span class="p">)</span>

    <span class="n">num_points</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">N</span>
    <span class="n">flights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">flight</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">lines</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">years</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">doys</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">num_points</span><span class="p">,</span> <span class="n">doy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">diurnal</span> <span class="o">=</span> <span class="n">diurnal_effect</span>

    <span class="n">igrf_initial</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span>
    
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">XYZ0</span><span class="p">(</span><span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span> <span class="n">traj</span><span class="o">=</span><span class="n">traj</span><span class="p">,</span> <span class="n">ins</span><span class="o">=</span><span class="n">ins</span><span class="p">,</span> <span class="n">flux_a</span><span class="o">=</span><span class="n">flux_a</span><span class="p">,</span>
               <span class="n">flight</span><span class="o">=</span><span class="n">flights</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span> <span class="n">year</span><span class="o">=</span><span class="n">years</span><span class="p">,</span> <span class="n">doy</span><span class="o">=</span><span class="n">doys</span><span class="p">,</span> <span class="c1"># Changed doys to doy</span>
               <span class="n">diurnal</span><span class="o">=</span><span class="n">diurnal</span><span class="p">,</span> <span class="n">igrf</span><span class="o">=</span><span class="n">igrf_initial</span><span class="p">,</span>
               <span class="n">mag_1_c</span><span class="o">=</span><span class="n">mag_1_c</span><span class="p">,</span> <span class="n">mag_1_uc</span><span class="o">=</span><span class="n">mag_1_uc</span><span class="p">)</span>

    <span class="n">igrf_vector_body</span> <span class="o">=</span> <span class="n">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">norm_igrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_xyz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="c1"># Ensure igrf_vector_body is suitable for np.linalg.norm, converting to float if necessary</span>
    <span class="c1"># This addresses potential TypeError if igrf_vector_body has an object dtype</span>
    <span class="c1"># or contains elements that np.sqrt (used by norm) cannot handle directly.</span>
    <span class="n">processed_igrf_vector_body</span> <span class="o">=</span> <span class="n">igrf_vector_body</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">igrf_vector_body</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">igrf_vector_body</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">number</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">processed_igrf_vector_body</span> <span class="o">=</span> <span class="n">igrf_vector_body</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="c1"># Assuming &#39;silent&#39; is in scope from create_xyz0 parameters</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO_CREATE_XYZ: Converted igrf_vector_body from dtype </span><span class="si">{</span><span class="n">igrf_vector_body</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> to float for norm calculation.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="c1"># Assuming &#39;silent&#39; is in scope</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;WARNING_CREATE_XYZ: Could not convert igrf_vector_body to float (dtype: </span><span class="si">{</span><span class="n">igrf_vector_body</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">). Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Proceeding with original.&quot;</span><span class="p">)</span>
            <span class="c1"># If conversion fails, use original and let np.linalg.norm handle it (it might still error)</span>
    
    <span class="c1"># Debugging for Error 1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_ERROR_1: type(processed_igrf_vector_body): </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">processed_igrf_vector_body</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processed_igrf_vector_body</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_ERROR_1: processed_igrf_vector_body.shape: </span><span class="si">{</span><span class="n">processed_igrf_vector_body</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_ERROR_1: processed_igrf_vector_body.dtype: </span><span class="si">{</span><span class="n">processed_igrf_vector_body</span><span class="o">.</span><span class="n">dtype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_ERROR_1: processed_igrf_vector_body: </span><span class="si">{</span><span class="n">processed_igrf_vector_body</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">igrf_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">processed_igrf_vector_body</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">xyz</span><span class="o">.</span><span class="n">igrf</span> <span class="o">=</span> <span class="n">igrf_scalar</span>

    <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">xyz_h5</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;flux_a_x&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;flux_a_x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">flux_a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;flux_a_x&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">x</span>
            <span class="k">if</span> <span class="s2">&quot;flux_a_y&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;flux_a_y&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">flux_a</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;flux_a_y&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">y</span>
            <span class="k">if</span> <span class="s2">&quot;flux_a_z&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;flux_a_z&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">flux_a</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;flux_a_z&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">z</span>
            <span class="k">if</span> <span class="s2">&quot;flux_a_t&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;flux_a_t&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">flux_a</span><span class="o">.</span><span class="n">t</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;flux_a_t&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">t</span>
            
            <span class="k">if</span> <span class="s2">&quot;mag_1_uc&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;mag_1_uc&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mag_1_uc</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;mag_1_uc&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">mag_1_uc</span>
            <span class="k">if</span> <span class="s2">&quot;mag_1_c&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;mag_1_c&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">mag_1_c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;mag_1_c&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">mag_1_c</span>
            
            <span class="k">if</span> <span class="s2">&quot;flight&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;flight&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">flights</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;flight&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">flights</span>
            <span class="k">if</span> <span class="s2">&quot;line&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;line&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">lines</span>
            <span class="k">if</span> <span class="s2">&quot;year&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">years</span>
            <span class="k">if</span> <span class="s2">&quot;doy&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;doy&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">doys</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;doy&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">doys</span>
            <span class="k">if</span> <span class="s2">&quot;diurnal&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;diurnal&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">diurnal</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;diurnal&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">diurnal</span>
            <span class="k">if</span> <span class="s2">&quot;igrf&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;igrf&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">xyz</span><span class="o">.</span><span class="n">igrf</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;igrf&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">igrf</span>
    <span class="k">return</span> <span class="n">xyz</span></div>


<div class="viewcode-block" id="create_traj">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_traj">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_traj</span><span class="p">(</span>
    <span class="n">mapS</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">],</span>
    <span class="n">alt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
    <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">,</span>
    <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">68.0</span><span class="p">,</span>
    <span class="n">ll1</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">ll2</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(),</span>
    <span class="n">N_waves</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">attempts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">save_h5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">traj_h5</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;traj_data.h5&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Traj</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create Traj trajectory struct with a straight or sinusoidal flight path.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">traj_h5</span> <span class="o">=</span> <span class="n">add_extension</span><span class="p">(</span><span class="n">traj_h5</span><span class="p">,</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mapS</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">valid_alts</span> <span class="o">=</span> <span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">[</span><span class="n">mapS</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="n">mapS</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">)]</span> <span class="c1"># mapS.alt is mapS.alt_matrix for MapSd</span>
        <span class="n">map_altitude_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_alts</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_alts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="s1">&#39;alt_matrix&#39;</span><span class="p">):</span> <span class="c1"># Explicit check for _ActualMapSd</span>
        <span class="n">valid_alts</span> <span class="o">=</span> <span class="n">mapS</span><span class="o">.</span><span class="n">alt_matrix</span><span class="p">[</span><span class="n">mapS</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="s1">&#39;mask&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mapS</span><span class="o">.</span><span class="n">mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">mapS</span><span class="o">.</span><span class="n">mask</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="n">mapS</span><span class="o">.</span><span class="n">alt_matrix</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">map_altitude_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">valid_alts</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_alts</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt_matrix</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span> <span class="c1"># For MapS3D</span>
        <span class="n">map_altitude_ref</span> <span class="o">=</span> <span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">))</span> <span class="k">else</span> <span class="n">mapS</span><span class="o">.</span><span class="n">alt</span> <span class="c1"># mapS.alt is mapS.zz for MapS3D</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="p">(</span><span class="n">_ActualMapS3D</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="s1">&#39;zz&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">zz</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="n">map_altitude_ref</span> <span class="o">=</span> <span class="n">mapS</span><span class="o">.</span><span class="n">zz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">alt</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span> <span class="c1"># For MapS</span>
         <span class="n">map_altitude_ref</span> <span class="o">=</span> <span class="n">mapS</span><span class="o">.</span><span class="n">alt</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot determine reference altitude from mapS&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">alt</span> <span class="o">&lt;</span> <span class="n">map_altitude_ref</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flight altitude </span><span class="si">{</span><span class="n">alt</span><span class="si">}</span><span class="s2"> &lt; map reference altitude </span><span class="si">{</span><span class="n">map_altitude_ref</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">N_pts</span> <span class="o">=</span> <span class="mi">2</span> 
    <span class="n">lat_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">lon_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="n">path_found_on_map</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">while</span> <span class="p">(</span><span class="ow">not</span> <span class="n">path_found_on_map</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">attempts</span><span class="p">)</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ll1</span><span class="p">:</span>
            <span class="n">lat_min</span><span class="p">,</span> <span class="n">lat_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">yy</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">yy</span><span class="p">)</span>
            <span class="n">lon_min</span><span class="p">,</span> <span class="n">lon_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">xx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mapS</span><span class="o">.</span><span class="n">xx</span><span class="p">)</span>
            <span class="n">lat1</span> <span class="o">=</span> <span class="n">lat_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">lat_max</span> <span class="o">-</span> <span class="n">lat_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">+</span> <span class="mf">0.50</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
            <span class="n">lon1</span> <span class="o">=</span> <span class="n">lon_min</span> <span class="o">+</span> <span class="p">(</span><span class="n">lon_max</span> <span class="o">-</span> <span class="n">lon_min</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.25</span> <span class="o">+</span> <span class="mf">0.50</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lat1</span><span class="p">,</span> <span class="n">lon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ll1</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ll1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ll2</span><span class="p">:</span>
            <span class="n">N_pts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">v</span> <span class="o">*</span> <span class="n">t</span>
            <span class="n">theta_utm</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
            <span class="n">lat2</span> <span class="o">=</span> <span class="n">lat1</span> <span class="o">+</span> <span class="n">dn2dlat</span><span class="p">(</span><span class="n">dist</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_utm</span><span class="p">),</span> <span class="n">lat1</span><span class="p">)</span>
            <span class="n">lon2</span> <span class="o">=</span> <span class="n">lon1</span> <span class="o">+</span> <span class="n">de2dlon</span><span class="p">(</span><span class="n">dist</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_utm</span><span class="p">),</span> <span class="n">lat1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">N_pts_est</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">*</span> <span class="p">(</span><span class="n">N_waves</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lat2</span><span class="p">,</span> <span class="n">lon2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ll2</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">ll2</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
        <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
        <span class="n">theta_ll</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">atan2</span><span class="p">(</span><span class="n">dlat</span><span class="p">,</span> <span class="n">dlon</span><span class="p">)</span>

        <span class="n">current_N</span> <span class="o">=</span> <span class="n">N_pts</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ll2</span> <span class="k">else</span> <span class="n">N_pts_est</span>
        <span class="n">lat_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span> <span class="n">lat2</span><span class="p">,</span> <span class="n">current_N</span><span class="p">)</span>
        <span class="n">lon_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">current_N</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">N_waves</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Simplified wave application; direct port of Julia&#39;s complex wave scaling is involved.</span>
            <span class="c1"># This part might need further refinement if precise wave shapes are critical.</span>
            <span class="n">phi_waves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">N_waves</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">current_N</span><span class="p">)</span>
            <span class="c1"># Assuming amplitude is relative or needs scaling factor based on path length.</span>
            <span class="c1"># For now, a simple perturbation perpendicular to the path.</span>
            <span class="c1"># A_wave_rad = 0.001 # Example amplitude in radians, adjust as needed</span>
            <span class="c1"># lat_path += A_wave_rad * np.cos(theta_ll) * np.sin(phi_waves) # Perpendicular to path</span>
            <span class="c1"># lon_path -= A_wave_rad * np.sin(theta_ll) * np.sin(phi_waves) # Perpendicular to path</span>
            <span class="c1"># The Julia code `wav = [ sin.()]` and rotation implies a more complex transformation.</span>
            <span class="c1"># Replicating Julia&#39;s `cor = wav*rot&#39;` logic:</span>
            <span class="n">_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">current_N</span><span class="p">)</span> <span class="c1"># Parametric distance</span>
            <span class="c1"># Amplitude of sin wave (relative to total length, scaled by dlat/dlon)</span>
            <span class="c1"># This is a simplification of the Julia logic which is non-trivial to map directly</span>
            <span class="c1"># without more context on the intended wave amplitude scaling.</span>
            <span class="c1"># The Julia code scales `sin.(phi_waves)` by rotation with `theta_ll`</span>
            <span class="c1"># and adds it to the base `lat1, lon1`.</span>
            <span class="c1"># `wav = [ sin.()]` -&gt; `wav = np.column_stack((_phi_scaled_dist, amp_scaled * np.sin(phi_waves)))`</span>
            <span class="c1"># `rot_matrix = np.array([[math.cos(theta_ll), -math.sin(theta_ll)],</span>
            <span class="c1">#                          [math.sin(theta_ll), math.cos(theta_ll)]])`</span>
            <span class="c1"># `cor = np.dot(wav, rot_matrix.T)`</span>
            <span class="c1"># `lon_path_wave = (cor[:,0] - cor[0,0]) + lon1`</span>
            <span class="c1"># `lat_path_wave = (cor[:,1] - cor[0,1]) + lat1`</span>
            <span class="c1"># For now, this part is simplified as the exact scaling in Julia was implicit.</span>
            <span class="k">pass</span>


        <span class="n">dx_m</span> <span class="o">=</span> <span class="n">dlon2de</span><span class="p">(</span><span class="n">fdm</span><span class="p">(</span><span class="n">lon_path</span><span class="p">),</span> <span class="n">lat_path</span><span class="p">)</span>
        <span class="n">dy_m</span> <span class="o">=</span> <span class="n">dlat2dn</span><span class="p">(</span><span class="n">fdm</span><span class="p">(</span><span class="n">lat_path</span><span class="p">),</span> <span class="n">lat_path</span><span class="p">)</span>
        
        <span class="n">valid_segments</span> <span class="o">=</span> <span class="p">(</span><span class="n">dx_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dy_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">valid_segments</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dx_m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span> <span class="c1"># fdm might return N or N-1 points</span>
            <span class="n">segment_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx_m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy_m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">current_total_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segment_distances</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">current_total_dist</span> <span class="o">=</span> <span class="mf">0.0</span>


        <span class="k">if</span> <span class="ow">not</span> <span class="n">ll2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current_total_dist</span> <span class="o">&gt;</span> <span class="mf">1e-6</span><span class="p">:</span>
                <span class="n">scale_factor</span> <span class="o">=</span> <span class="n">dist</span> <span class="o">/</span> <span class="n">current_total_dist</span>
                <span class="n">lat_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_path</span> <span class="o">-</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="o">+</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">lon_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_path</span> <span class="o">-</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_factor</span> <span class="o">+</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lat_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-9</span> <span class="p">:</span>
                 <span class="n">scale_factor_lat</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat2</span> <span class="o">-</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lat_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                 <span class="n">lat_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">lat_path</span> <span class="o">-</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_factor_lat</span> <span class="o">+</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">lon_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mf">1e-9</span><span class="p">:</span>
                 <span class="n">scale_factor_lon</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon2</span> <span class="o">-</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">lon_path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                 <span class="n">lon_path</span> <span class="o">=</span> <span class="p">(</span><span class="n">lon_path</span> <span class="o">-</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">scale_factor_lon</span> <span class="o">+</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">ll2</span><span class="p">:</span>
            <span class="n">dx_m</span> <span class="o">=</span> <span class="n">dlon2de</span><span class="p">(</span><span class="n">fdm</span><span class="p">(</span><span class="n">lon_path</span><span class="p">),</span> <span class="n">lat_path</span><span class="p">)</span>
            <span class="n">dy_m</span> <span class="o">=</span> <span class="n">dlat2dn</span><span class="p">(</span><span class="n">fdm</span><span class="p">(</span><span class="n">lat_path</span><span class="p">),</span> <span class="n">lat_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dx_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">dy_m</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">dx_m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">segment_distances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx_m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dy_m</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">true_dist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">segment_distances</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">true_dist</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="n">t_flight</span> <span class="o">=</span> <span class="n">true_dist</span> <span class="o">/</span> <span class="n">v</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">N_pts</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">t_flight</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="mi">1</span>
            <span class="n">N_pts</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># Ensure at least 2 points for interpolation</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">:</span>
                <span class="n">current_progression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_path</span><span class="p">))</span>
                <span class="n">new_progression</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">N_pts</span><span class="p">)</span>
                <span class="n">interp_lat</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">current_progression</span><span class="p">,</span> <span class="n">lat_path</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
                <span class="n">interp_lon</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">current_progression</span><span class="p">,</span> <span class="n">lon_path</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
                <span class="n">lat_path</span> <span class="o">=</span> <span class="n">interp_lat</span><span class="p">(</span><span class="n">new_progression</span><span class="p">)</span>
                <span class="n">lon_path</span> <span class="o">=</span> <span class="n">interp_lon</span><span class="p">(</span><span class="n">new_progression</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_path</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># Single point from previous step</span>
                <span class="n">lat_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">lat_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">lon_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">lon_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># No points, should not happen if N_pts_est was &gt; 0</span>
                <span class="n">lat_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">lat1</span><span class="p">)</span> <span class="c1"># Fallback</span>
                <span class="n">lon_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">lon1</span><span class="p">)</span> <span class="c1"># Fallback</span>

            <span class="n">t</span> <span class="o">=</span> <span class="n">t_flight</span>

        <span class="n">path_found_on_map</span> <span class="o">=</span> <span class="n">map_check</span><span class="p">(</span><span class="n">mapS</span><span class="p">,</span> <span class="n">lat_path</span><span class="p">,</span> <span class="n">lon_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">path_found_on_map</span><span class="p">:</span>
            <span class="k">break</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_found_on_map</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum attempts (</span><span class="si">{</span><span class="n">attempts</span><span class="si">}</span><span class="s2">) reached, could not create valid trajectory on map.&quot;</span><span class="p">)</span>

    <span class="n">mean_lat_deg_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lat_path</span><span class="p">))</span>
    <span class="n">mean_lon_deg_traj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">lon_path</span><span class="p">))</span>
    <span class="n">utm_zone_num</span><span class="p">,</span> <span class="n">utm_is_north</span> <span class="o">=</span> <span class="n">utm_zone_from_latlon</span><span class="p">(</span><span class="n">mean_lat_deg_traj</span><span class="p">,</span> <span class="n">mean_lon_deg_traj</span><span class="p">)</span>
    
    <span class="n">utms_x</span><span class="p">,</span> <span class="n">utms_y</span> <span class="o">=</span> <span class="n">transform_lla_to_utm</span><span class="p">(</span><span class="n">lat_path</span><span class="p">,</span> <span class="n">lon_path</span><span class="p">,</span> <span class="n">utm_zone_num</span><span class="p">,</span> <span class="n">utm_is_north</span><span class="p">)</span>

    <span class="n">vn</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">utms_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span> <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">utms_y</span><span class="p">)</span>
    <span class="n">ve</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">utms_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span> <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">utms_x</span><span class="p">)</span>
    <span class="n">vd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lat_path</span><span class="p">)</span>
    
    <span class="n">fn</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span> <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vn</span><span class="p">)</span>
    <span class="n">fe</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">ve</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span> <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">ve</span><span class="p">)</span>
    <span class="n">fd</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">vd</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">-</span> <span class="n">G_EARTH</span> <span class="k">if</span> <span class="n">dt</span> <span class="o">&gt;</span> <span class="mf">1e-6</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">vd</span><span class="p">,</span> <span class="o">-</span><span class="n">G_EARTH</span><span class="p">)</span> <span class="c1"># Changed to G_EARTH</span>
    
    <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">N_pts</span><span class="p">)</span>

    <span class="n">Cnb_array_wrong_dims</span> <span class="o">=</span> <span class="n">create_dcm_from_vel</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="n">ve</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;body2nav&#39;</span><span class="p">)</span> <span class="c1"># Shape (N, 3, 3)</span>
    <span class="n">Cnb_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">Cnb_array_wrong_dims</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="c1"># Shape (3, 3, N)</span>
    <span class="n">euler_angles</span> <span class="o">=</span> <span class="n">dcm2euler</span><span class="p">(</span><span class="n">Cnb_array</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;body2nav&#39;</span><span class="p">)</span> <span class="c1"># Now Cnb_array is (3,3,N)</span>
    <span class="n">roll_path</span>  <span class="o">=</span> <span class="n">euler_angles</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">pitch_path</span> <span class="o">=</span> <span class="n">euler_angles</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yaw_path</span>   <span class="o">=</span> <span class="n">euler_angles</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">alt_path</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">lat_path</span><span class="p">,</span> <span class="n">alt</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">traj_h5</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data_arr</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="p">(</span><span class="s2">&quot;tt&quot;</span><span class="p">,</span> <span class="n">tt</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="n">lat_path</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="n">lon_path</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;alt&quot;</span><span class="p">,</span> <span class="n">alt_path</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;vn&quot;</span><span class="p">,</span> <span class="n">vn</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;ve&quot;</span><span class="p">,</span> <span class="n">ve</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;vd&quot;</span><span class="p">,</span> <span class="n">vd</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fn&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fe&quot;</span><span class="p">,</span> <span class="n">fe</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;fd&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="p">),</span>
                <span class="p">(</span><span class="s2">&quot;roll&quot;</span><span class="p">,</span> <span class="n">roll_path</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;pitch&quot;</span><span class="p">,</span> <span class="n">pitch_path</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;yaw&quot;</span><span class="p">,</span> <span class="n">yaw_path</span><span class="p">)</span>
            <span class="p">]:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data_arr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="n">key</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">data_arr</span>
                
    <span class="k">return</span> <span class="n">Traj</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N_pts</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="n">tt</span><span class="p">,</span> <span class="n">lat</span><span class="o">=</span><span class="n">lat_path</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon_path</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="n">alt_path</span><span class="p">,</span>
                <span class="n">vn</span><span class="o">=</span><span class="n">vn</span><span class="p">,</span> <span class="n">ve</span><span class="o">=</span><span class="n">ve</span><span class="p">,</span> <span class="n">vd</span><span class="o">=</span><span class="n">vd</span><span class="p">,</span> <span class="n">fn</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">fe</span><span class="o">=</span><span class="n">fe</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">fd</span><span class="p">,</span> <span class="n">Cnb</span><span class="o">=</span><span class="n">Cnb_array</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_ins">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_ins">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_ins</span><span class="p">(</span>
    <span class="n">traj</span><span class="p">:</span> <span class="n">Traj</span><span class="p">,</span>
    <span class="n">init_pos_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">init_alt_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">init_vel_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">init_att_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">),</span>
    <span class="n">VRW_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.000238</span><span class="p">,</span>
    <span class="n">ARW_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.000000581</span><span class="p">,</span>
    <span class="n">baro_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">ha_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">a_hat_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="n">acc_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.000245</span><span class="p">,</span>
    <span class="n">gyro_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.00000000727</span><span class="p">,</span>
    <span class="n">baro_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">acc_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">gyro_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3600.0</span><span class="p">,</span>
    <span class="n">save_h5</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ins_h5</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;ins_data.h5&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">INS</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates an INS trajectory about a true trajectory using a Pinson error model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ins_h5</span> <span class="o">=</span> <span class="n">add_extension</span><span class="p">(</span><span class="n">ins_h5</span><span class="p">,</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

    <span class="n">N</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">N</span>
    <span class="n">dt</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">dt</span>
    <span class="n">nx</span> <span class="o">=</span> <span class="mi">17</span>

    <span class="c1"># Define std_acc from the acc_sigma parameter of create_ins</span>
    <span class="n">std_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">acc_sigma</span><span class="p">,</span> <span class="n">acc_sigma</span><span class="p">,</span> <span class="n">acc_sigma</span><span class="p">])</span>

    <span class="c1"># Placeholder values for missing arguments as per prompt&#39;s specific instruction</span>
    <span class="n">placeholder_std_gyro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
    <span class="n">placeholder_tau_acc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">])</span>
    <span class="n">placeholder_tau_gyro</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">])</span>

    <span class="n">P0</span><span class="p">,</span> <span class="n">Qd</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">create_ins_model_matrices</span><span class="p">(</span>
        <span class="n">dt</span><span class="p">,</span>
        <span class="n">std_acc</span><span class="p">,</span> <span class="c1"># Correctly use std_acc derived from acc_sigma</span>
        <span class="n">placeholder_std_gyro</span><span class="p">,</span>
        <span class="n">placeholder_tau_acc</span><span class="p">,</span>
        <span class="n">placeholder_tau_gyro</span><span class="p">,</span>
        <span class="c1"># Pass through other relevant kwargs from the original call and create_ins parameters</span>
        <span class="n">init_pos_sigma</span><span class="o">=</span><span class="n">init_pos_sigma</span><span class="p">,</span>
        <span class="n">init_alt_sigma</span><span class="o">=</span><span class="n">init_alt_sigma</span><span class="p">,</span> <span class="c1"># Was in original kwargs</span>
        <span class="n">init_vel_sigma</span><span class="o">=</span><span class="n">init_vel_sigma</span><span class="p">,</span>
        <span class="n">init_att_sigma</span><span class="o">=</span><span class="n">init_att_sigma</span><span class="p">,</span>
        <span class="n">VRW_sigma</span><span class="o">=</span><span class="n">VRW_sigma</span><span class="p">,</span>       <span class="c1"># Was in original kwargs</span>
        <span class="n">ARW_sigma</span><span class="o">=</span><span class="n">ARW_sigma</span><span class="p">,</span>       <span class="c1"># Was in original kwargs</span>
        <span class="n">baro_sigma</span><span class="o">=</span><span class="n">baro_sigma</span><span class="p">,</span>     <span class="c1"># Was in original kwargs</span>
        <span class="n">ha_sigma</span><span class="o">=</span><span class="n">ha_sigma</span><span class="p">,</span>         <span class="c1"># Was in original kwargs</span>
        <span class="n">a_hat_sigma</span><span class="o">=</span><span class="n">a_hat_sigma</span><span class="p">,</span>   <span class="c1"># Was in original kwargs</span>
        <span class="n">fogm_state</span><span class="o">=</span><span class="kc">False</span>           <span class="c1"># Was in original kwargs</span>
    <span class="p">)</span>

    <span class="n">P_ins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>
    <span class="n">err_ins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N</span><span class="p">,</span> <span class="n">nx</span><span class="p">))</span>

    <span class="n">P_ins</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">P0</span>
    <span class="n">err_ins</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">multivariate_normal</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="n">cov</span><span class="o">=</span><span class="n">P0</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">Qd_chol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Qd</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="c1"># If Qd is not positive definite, add small identity to diagonal</span>
        <span class="n">Qd_chol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">Qd</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-12</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">lat_k</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">vn_k</span>  <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">vn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">vn</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">vn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">ve_k</span>  <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">ve</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">ve</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">vd_k</span>  <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">vd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">vd</span><span class="p">)</span>  <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">vd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">fn_k</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">fn</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">fn</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">fe_k</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">fe</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">fe</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">fe</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">fd_k</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">fd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">fd</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">fd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">Cnb_k</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">Phi_k</span> <span class="o">=</span> <span class="n">get_phi_matrix</span><span class="p">(</span>
            <span class="n">nx</span><span class="p">,</span> <span class="n">lat_k</span><span class="p">,</span> <span class="n">vn_k</span><span class="p">,</span> <span class="n">ve_k</span><span class="p">,</span> <span class="n">vd_k</span><span class="p">,</span>
            <span class="n">fn_k</span><span class="p">,</span> <span class="n">fe_k</span><span class="p">,</span> <span class="n">fd_k</span><span class="p">,</span> <span class="n">Cnb_k</span><span class="p">,</span> <span class="c1"># Pass Cnb for current step</span>
            <span class="n">baro_tau</span><span class="p">,</span> <span class="n">acc_tau</span><span class="p">,</span> <span class="n">gyro_tau</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fogm_state</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">process_noise_k</span> <span class="o">=</span> <span class="n">Qd_chol</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
        <span class="n">err_ins</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">Phi_k</span> <span class="o">@</span> <span class="n">err_ins</span><span class="p">[</span><span class="n">k</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">process_noise_k</span>
        <span class="n">P_ins</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="n">Phi_k</span> <span class="o">@</span> <span class="n">P_ins</span><span class="p">[</span><span class="n">k</span><span class="p">,:,:]</span> <span class="o">@</span> <span class="n">Phi_k</span><span class="o">.</span><span class="n">T</span> <span class="o">+</span> <span class="n">Qd</span>

    <span class="c1"># Create noisy trajectory based on true trajectory and error</span>
    <span class="n">lat_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">lat</span> <span class="o">+</span> <span class="n">err_ins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">dn2dlat</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="c1"># Convert northing error to dlat</span>
    <span class="n">lon_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">lon</span> <span class="o">+</span> <span class="n">err_ins</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">de2dlon</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span> <span class="c1"># Convert easting error to dlon</span>
    <span class="n">alt_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">alt</span> <span class="o">-</span> <span class="n">err_ins</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># NED: down is positive, so error in d is subtracted from alt</span>

    <span class="n">vn_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">vn</span> <span class="o">+</span> <span class="n">err_ins</span><span class="p">[:,</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">ve_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">ve</span> <span class="o">+</span> <span class="n">err_ins</span><span class="p">[:,</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">vd_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">vd</span> <span class="o">+</span> <span class="n">err_ins</span><span class="p">[:,</span><span class="mi">5</span><span class="p">]</span>

    <span class="c1"># Correct Cnb matrix with attitude error</span>
    <span class="c1"># err_ins[:,6:9] are tilt errors (alpha, beta, gamma for small angle approx or specific error def)</span>
    <span class="c1"># Assuming these are psi_nb errors (n, e, d components of rotation vector error)</span>
    <span class="c1"># Cnb_ins = Cnb_true @ (I - skew(psi_nb_err)) approx</span>
    <span class="c1"># Or if err_ins are Euler angle errors, Cnb_ins = Cnb_true @ delta_Cnb(deuler)</span>
    <span class="c1"># For simplicity, assuming direct correction or that correct_cnb_matrix handles it.</span>
    <span class="c1"># The Julia code uses: Cnb_ins[k,:,:] = correct_cnb_matrix(traj.Cnb[k,:,:], err_ins[k,6:9])</span>
    <span class="n">Cnb_ins_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">correct_cnb_matrix</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">Cnb</span><span class="p">[:,:],</span> <span class="n">err_ins</span><span class="p">[</span><span class="n">k</span><span class="p">,</span><span class="mi">6</span><span class="p">:</span><span class="mi">9</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">)])</span>

    <span class="c1"># Specific forces from INS (derived from noisy accels, transformed by noisy Cnb)</span>
    <span class="c1"># This part is complex as it depends on how acc_bias (err_ins[:,11:14]) and gyro_bias (err_ins[:,14:17])</span>
    <span class="c1"># are defined and how they corrupt true specific force.</span>
    <span class="c1"># For now, assume fn, fe, fd are &quot;measured&quot; specific forces in nav frame.</span>
    <span class="c1"># A simplified approach: add noise to true specific forces.</span>
    <span class="c1"># However, INS specific forces are usually derived from accelerometer outputs.</span>
    <span class="c1"># Let&#39;s assume for now that the error terms for fn,fe,fd are implicitly handled</span>
    <span class="c1"># or that the true fn,fe,fd are used as a base, which is not entirely realistic for INS output.</span>
    <span class="c1"># A more accurate model would involve simulating accelerometer outputs with bias/noise,</span>
    <span class="c1"># then transforming with Cnb_ins.</span>
    <span class="c1"># Using traj.fn, fe, fd as placeholders for what INS would compute before error accumulation in fn/fe/fd states.</span>
    <span class="n">fn_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">fn</span> <span class="c1"># Placeholder - needs more accurate modeling if INS specific force output is critical</span>
    <span class="n">fe_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">fe</span> <span class="c1"># Placeholder</span>
    <span class="n">fd_ins</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">fd</span> <span class="c1"># Placeholder</span>

    <span class="n">ins_trajectory</span> <span class="o">=</span> <span class="n">INS</span><span class="p">(</span>
        <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">tt</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">tt</span><span class="p">,</span>
        <span class="n">lat</span><span class="o">=</span><span class="n">lat_ins</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">lon_ins</span><span class="p">,</span> <span class="n">alt</span><span class="o">=</span><span class="n">alt_ins</span><span class="p">,</span>
        <span class="n">vn</span><span class="o">=</span><span class="n">vn_ins</span><span class="p">,</span> <span class="n">ve</span><span class="o">=</span><span class="n">ve_ins</span><span class="p">,</span> <span class="n">vd</span><span class="o">=</span><span class="n">vd_ins</span><span class="p">,</span>
        <span class="n">fn</span><span class="o">=</span><span class="n">fn_ins</span><span class="p">,</span> <span class="n">fe</span><span class="o">=</span><span class="n">fe_ins</span><span class="p">,</span> <span class="n">fd</span><span class="o">=</span><span class="n">fd_ins</span><span class="p">,</span> <span class="c1"># These should ideally be from INS processing</span>
        <span class="n">Cnb</span><span class="o">=</span><span class="n">Cnb_ins_array</span><span class="p">,</span>
        <span class="n">P</span><span class="o">=</span><span class="n">P_ins</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">save_h5</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">ins_h5</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span> <span class="c1"># Append mode</span>
            <span class="c1"># Save all fields from Traj part of INS</span>
            <span class="k">if</span> <span class="s2">&quot;tt_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;tt_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">tt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;tt_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">tt</span> <span class="c1"># Overwrite if exists</span>
            <span class="k">if</span> <span class="s2">&quot;lat_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;lat_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;lat_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">lat</span>
            <span class="k">if</span> <span class="s2">&quot;lon_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;lon_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">lon</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;lon_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">lon</span>
            <span class="k">if</span> <span class="s2">&quot;alt_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;alt_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">alt</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;alt_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">alt</span>
            <span class="k">if</span> <span class="s2">&quot;vn_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;vn_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">vn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;vn_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">vn</span>
            <span class="k">if</span> <span class="s2">&quot;ve_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;ve_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">ve</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;ve_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">ve</span>
            <span class="k">if</span> <span class="s2">&quot;vd_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;vd_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">vd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;vd_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">vd</span>
            <span class="k">if</span> <span class="s2">&quot;fn_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;fn_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">fn</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;fn_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">fn</span>
            <span class="k">if</span> <span class="s2">&quot;fe_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;fe_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">fe</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;fe_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">fe</span>
            <span class="k">if</span> <span class="s2">&quot;fd_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;fd_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">fd</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;fd_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">ins_trajectory</span><span class="o">.</span><span class="n">fd</span>
            
            <span class="c1"># Save Cnb components (roll, pitch, yaw from INS DCMs)</span>
            <span class="n">euler_ins</span> <span class="o">=</span> <span class="n">dcm2euler</span><span class="p">(</span><span class="n">ins_trajectory</span><span class="o">.</span><span class="n">Cnb</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;body2nav&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;roll_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;roll_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">euler_ins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;roll_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">euler_ins</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;pitch_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;pitch_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">euler_ins</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;pitch_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">euler_ins</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;yaw_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;yaw_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">euler_ins</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;yaw_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">euler_ins</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span>

            <span class="c1"># Save covariance P (example: diagonal elements for variances)</span>
            <span class="c1"># P_diag = np.array([P_ins[k,:,:].diagonal() for k in range(N)])</span>
            <span class="c1"># if &quot;P_diag_ins&quot; not in file: file.create_dataset(&quot;P_diag_ins&quot;, data=P_diag)</span>
            <span class="c1"># else: file[&quot;P_diag_ins&quot;][:] = P_diag</span>
            <span class="c1"># Or save full P if needed, careful with size:</span>
            <span class="k">if</span> <span class="s2">&quot;P_ins&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span> <span class="n">file</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s2">&quot;P_ins&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">P_ins</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;P_ins&quot;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">P_ins</span>
            
    <span class="k">return</span> <span class="n">ins_trajectory</span></div>


<div class="viewcode-block" id="create_mag_c">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_mag_c">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_mag_c</span><span class="p">(</span>
    <span class="n">path_or_lat</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">lon_or_mapS</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alt_or_itp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interp1d</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">itp_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">map_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">meas_var</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fogm_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">fogm_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">600.0</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Required if path_or_lat is not Path and fogm is used</span>
    <span class="n">map_resolution_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">200.0</span><span class="p">,</span> <span class="c1"># Corresponds to alpha in get_map_val</span>
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates compensated (clean) scalar magnetometer measurements.</span>
<span class="sd">    Can take a Path object or explicit lat, lon, alt arrays.</span>

<span class="sd">    Args:</span>
<span class="sd">        path_or_lat: Path object (Traj or INS) or 1D array of latitudes [rad].</span>
<span class="sd">        lon_or_mapS: 1D array of longitudes [rad] OR a MapS/MapSd/MapS3D object.</span>
<span class="sd">                     Required if path_or_lat is lat array. If Path is given, this can be a map object</span>
<span class="sd">                     to use directly, or None/path_string if map needs to be loaded via alt_or_itp.</span>
<span class="sd">        alt_or_itp: 1D array of altitudes [m] OR a scalar altitude OR a map path string OR</span>
<span class="sd">                    a precomputed scipy interpolator. Required if path_or_lat is lat array.</span>
<span class="sd">                    If Path is given and lon_or_mapS is not a map object, this can be a map_path string.</span>
<span class="sd">        itp_kwargs: Dict of keyword arguments for scipy.interpolate.interp1d if creating interpolator.</span>
<span class="sd">        map_kwargs: Dict of keyword arguments for get_map if loading map from path.</span>
<span class="sd">        meas_var: Measurement variance for white noise [nT^2].</span>
<span class="sd">        fogm_sigma: FOGM noise standard deviation [nT].</span>
<span class="sd">        fogm_tau: FOGM noise correlation time [s].</span>
<span class="sd">        dt: Time step [s], required for FOGM noise if path_or_lat is not a Path object.</span>
<span class="sd">        map_resolution_scale: Scaling factor for map resolution, passed as &#39;alpha&#39; to get_map_val.</span>
<span class="sd">        silent: Suppress print statements.</span>

<span class="sd">    Returns:</span>
<span class="sd">        mag_c: 1D array of compensated scalar magnetometer measurements [nT].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">itp_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">itp_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">map_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">map_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">map_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_lat</span><span class="p">,</span> <span class="p">(</span><span class="n">Traj</span><span class="p">,</span> <span class="n">INS</span><span class="p">)):</span> <span class="c1"># Path object provided</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="n">path_or_lat</span><span class="o">.</span><span class="n">N</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># dt for FOGM noise</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="n">path_or_lat</span><span class="o">.</span><span class="n">dt</span>

        <span class="c1"># MODIFIED LOGIC FOR MAP SELECTION</span>
        <span class="n">map_to_use</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Initialize</span>

        <span class="c1"># Define all possible map types for lon_or_mapS.</span>
        <span class="n">_map_types</span> <span class="o">=</span> <span class="p">(</span><span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">_ActualMapS3D</span><span class="p">,</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon_or_mapS</span><span class="p">,</span> <span class="n">_map_types</span><span class="p">):</span>
            <span class="n">map_to_use</span> <span class="o">=</span> <span class="n">lon_or_mapS</span>
        
        <span class="k">if</span> <span class="n">map_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># If no map object from lon_or_mapS</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># Check if alt_or_itp is a path</span>
                <span class="n">_path_to_load_map_from</span> <span class="o">=</span> <span class="n">alt_or_itp</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_path_to_load_map_from</span><span class="p">):</span>
                     <span class="n">_path_to_load_map_from</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">_path_to_load_map_from</span><span class="p">,</span> <span class="n">return_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading map from path: </span><span class="si">{</span><span class="n">_path_to_load_map_from</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">final_map_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">map_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;silent&#39;</span><span class="p">}</span>
                <span class="n">map_to_use</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">_path_to_load_map_from</span><span class="p">,</span> <span class="o">**</span><span class="n">final_map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># Not a map object, and not a path string, so use default</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default scalar map. No valid map object or path string given.&quot;</span><span class="p">)</span>
                <span class="n">final_map_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">map_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;silent&#39;</span><span class="p">}</span>
                <span class="n">map_to_use</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_SCALAR_MAP_ID</span><span class="p">,</span> <span class="o">**</span><span class="n">final_map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        
        <span class="c1"># Ensure map_to_use is not None before proceeding (critical fallback)</span>
        <span class="k">if</span> <span class="n">map_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Critical fallback: map_to_use was still None after checks. Using default scalar map.&quot;</span><span class="p">)</span>
            <span class="n">final_map_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">map_kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s1">&#39;silent&#39;</span><span class="p">}</span>
            <span class="n">map_to_use</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_SCALAR_MAP_ID</span><span class="p">,</span> <span class="o">**</span><span class="n">final_map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="c1"># END OF MODIFIED LOGIC</span>
        
        <span class="n">map_val</span> <span class="o">=</span> <span class="n">get_map_val</span><span class="p">(</span><span class="n">map_to_use</span><span class="p">,</span> <span class="n">path_or_lat</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">path_or_lat</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">path_or_lat</span><span class="o">.</span><span class="n">alt</span><span class="p">,</span>
                               <span class="n">return_interpolator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_lat</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span> <span class="c1"># lat, lon, alt arrays provided</span>
        <span class="n">_lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_or_lat</span><span class="p">)</span>
        <span class="n">_lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_or_mapS</span><span class="p">)</span> <span class="c1"># Here lon_or_mapS must be lon array</span>
        <span class="n">_alt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">alt_or_itp</span> <span class="c1"># alt_or_itp can be alt array, scalar, path, or itp</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">_lat</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">_lon</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Latitude and longitude must be 1D arrays.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">_lat</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">_lon</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Latitude and longitude arrays must have the same shape.&quot;</span><span class="p">)</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="n">_lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">):</span> <span class="c1"># Precomputed interpolator</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using precomputed interpolator for map values.&quot;</span><span class="p">)</span>
            <span class="n">points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">_lat</span><span class="p">,</span> <span class="n">_lon</span><span class="p">))</span>
            <span class="n">map_val</span> <span class="o">=</span> <span class="n">alt_or_itp</span><span class="p">(</span><span class="n">points</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon_or_mapS</span><span class="p">,</span> <span class="p">(</span><span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">_ActualMapS3D</span><span class="p">,</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">)):</span>
            <span class="n">map_obj_or_path</span> <span class="o">=</span> <span class="n">lon_or_mapS</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon_or_mapS</span><span class="p">,</span> <span class="p">(</span><span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">_ActualMapS3D</span><span class="p">,</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">))</span> <span class="k">else</span> <span class="n">alt_or_itp</span>
            
            <span class="n">current_map_to_use</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">_ActualMapS3D</span><span class="p">,</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_obj_or_path</span><span class="p">,</span> <span class="p">(</span><span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">_ActualMapS3D</span><span class="p">,</span> <span class="n">MapS</span><span class="p">,</span> <span class="n">MapSd</span><span class="p">,</span> <span class="n">MapS3D</span><span class="p">)):</span>
                <span class="n">current_map_to_use</span> <span class="o">=</span> <span class="n">map_obj_or_path</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_obj_or_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">_path</span> <span class="o">=</span> <span class="n">map_obj_or_path</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">_path</span><span class="p">):</span> <span class="n">_path</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">_path</span><span class="p">,</span> <span class="n">return_path</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading map from path: </span><span class="si">{</span><span class="n">_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">current_map_to_use</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">_path</span><span class="p">,</span> <span class="n">map_kwargs</span><span class="o">=</span><span class="n">map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using default map for array input due to unclear map source.&quot;</span><span class="p">)</span>
                <span class="n">current_map_to_use</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">DEFAULT_SCALAR_MAP_ID</span><span class="p">,</span> <span class="n">map_kwargs</span><span class="o">=</span><span class="n">map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">current_map_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                 <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to obtain a map object for array input.&quot;</span><span class="p">)</span>

            <span class="n">alt_for_map_val</span> <span class="o">=</span> <span class="n">_alt</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_alt</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">_alt</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">alt_for_map_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_map_to_use</span><span class="o">.</span><span class="n">alt</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">)):</span>
                    <span class="n">alt_for_map_val</span> <span class="o">=</span> <span class="n">current_map_to_use</span><span class="o">.</span><span class="n">alt</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using map&#39;s own altitude (</span><span class="si">{</span><span class="n">alt_for_map_val</span><span class="si">}</span><span class="s2">m) for map value calculation.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Altitude must be provided as array or scalar when lat/lon are arrays and map is 3D/drape without explicit point altitudes.&quot;</span><span class="p">)</span>

            <span class="n">map_val</span> <span class="o">=</span> <span class="n">get_map_val</span><span class="p">(</span><span class="n">current_map_to_use</span><span class="p">,</span> <span class="n">_lat</span><span class="p">,</span> <span class="n">_lon</span><span class="p">,</span> <span class="n">alt_for_map_val</span><span class="p">,</span>
                                  <span class="n">alpha</span><span class="o">=</span><span class="n">map_resolution_scale</span><span class="p">,</span> <span class="n">return_interpolator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using default scalar map for array input.&quot;</span><span class="p">)</span>
            <span class="n">default_map</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">DEFAULT_SCALAR_MAP_ID</span><span class="p">,</span> <span class="n">map_kwargs</span><span class="o">=</span><span class="n">map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            <span class="n">map_val</span> <span class="o">=</span> <span class="n">get_map_val</span><span class="p">(</span><span class="n">default_map</span><span class="p">,</span> <span class="n">_lat</span><span class="p">,</span> <span class="n">_lon</span><span class="p">,</span> <span class="n">_alt</span><span class="p">,</span> 
                                  <span class="n">alpha</span><span class="o">=</span><span class="n">map_resolution_scale</span><span class="p">,</span> <span class="n">return_interpolator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;path_or_lat must be a Path object or a list/array of latitudes.&quot;</span><span class="p">)</span>

    <span class="c1"># Add FOGM noise</span>
    <span class="k">if</span> <span class="n">fogm_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fogm_tau</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dt must be provided for FOGM noise when not using a Path object.&quot;</span><span class="p">)</span>
        <span class="n">fogm_noise</span> <span class="o">=</span> <span class="n">generate_fogm_noise</span><span class="p">(</span><span class="n">fogm_sigma</span><span class="p">,</span> <span class="n">fogm_tau</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
        <span class="n">map_val</span> <span class="o">+=</span> <span class="n">fogm_noise</span>

    <span class="c1"># Add white measurement noise</span>
    <span class="k">if</span> <span class="n">meas_var</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">white_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">meas_var</span><span class="p">)</span>
        <span class="n">map_val</span> <span class="o">+=</span> <span class="n">white_noise</span>
        
    <span class="k">return</span> <span class="n">map_val</span></div>



<div class="viewcode-block" id="corrupt_mag">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.corrupt_mag">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">corrupt_mag</span><span class="p">(</span>
    <span class="n">mag_c</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="n">flux_a</span><span class="p">:</span> <span class="n">MagV</span><span class="p">,</span> <span class="c1"># True vector field in aircraft body frame</span>
    <span class="n">traj_ideal</span><span class="p">:</span> <span class="n">Traj</span><span class="p">,</span>
    <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">cor_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">cor_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">600.0</span><span class="p">,</span>
    <span class="n">cor_var</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
    <span class="n">cor_drift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.001</span><span class="p">,</span>
    <span class="n">cor_perm_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">cor_ind_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">,</span>
    <span class="n">cor_eddy_mag</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
    <span class="n">terms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">Bt_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50000.0</span> <span class="c1"># Typical Earth field magnitude for scaling TL coeffs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Corrupts clean scalar magnetometer data with various noise sources.</span>

<span class="sd">    Args:</span>
<span class="sd">        mag_c: Clean scalar magnetometer data [nT].</span>
<span class="sd">        flux_a: True vector magnetometer measurements (MagV struct) in aircraft body frame [nT].</span>
<span class="sd">        dt: Time step [s].</span>
<span class="sd">        cor_sigma: FOGM noise std dev for diurnal [nT].</span>
<span class="sd">        cor_tau: FOGM noise correlation time for diurnal [s].</span>
<span class="sd">        cor_var: Measurement variance for white noise on diurnal [nT^2].</span>
<span class="sd">        cor_drift: Constant drift rate for diurnal [nT/s].</span>
<span class="sd">        cor_perm_mag: Magnitude of permanent magnetic field coefficients [nT].</span>
<span class="sd">        cor_ind_mag: Magnitude of induced magnetic field coefficients [-].</span>
<span class="sd">        cor_eddy_mag: Magnitude of eddy current magnetic field coefficients [s].</span>
<span class="sd">        terms: Tolles-Lawson terms to use for aircraft field. Defaults to [&#39;permanent&#39;, &#39;induced&#39;, &#39;eddy&#39;].</span>
<span class="sd">        Bt_scale: Scaling factor for Tolles-Lawson coefficients, typically Earth&#39;s total field strength.</span>


<span class="sd">    Returns:</span>
<span class="sd">        Tuple containing:</span>
<span class="sd">            - mag_uc (np.ndarray): Uncompensated (corrupted) scalar mag data [nT].</span>
<span class="sd">            - aircraft_field_scalar (np.ndarray): Scalar aircraft-generated magnetic field [nT].</span>
<span class="sd">            - diurnal_effect (np.ndarray): Simulated diurnal variation [nT].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">terms</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;permanent&#39;</span><span class="p">,</span> <span class="s1">&#39;induced&#39;</span><span class="p">,</span> <span class="s1">&#39;eddy&#39;</span><span class="p">]</span>

    <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mag_c</span><span class="p">)</span>

    <span class="c1"># 1. Simulate diurnal variation</span>
    <span class="n">diurnal_fogm</span> <span class="o">=</span> <span class="n">generate_fogm_noise</span><span class="p">(</span><span class="n">cor_sigma</span><span class="p">,</span> <span class="n">cor_tau</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">diurnal_drift</span> <span class="o">=</span> <span class="n">cor_drift</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>
    <span class="n">diurnal_white_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cor_var</span><span class="p">)</span>
    <span class="n">diurnal_effect</span> <span class="o">=</span> <span class="n">diurnal_fogm</span> <span class="o">+</span> <span class="n">diurnal_drift</span> <span class="o">+</span> <span class="n">diurnal_white_noise</span>

    <span class="c1"># 2. Simulate aircraft-generated magnetic field (Tolles-Lawson)</span>
    <span class="n">B_earth_body_x</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">x</span>
    <span class="n">B_earth_body_y</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">y</span>
    <span class="n">B_earth_body_z</span> <span class="o">=</span> <span class="n">flux_a</span><span class="o">.</span><span class="n">z</span>
    <span class="n">B_earth_body</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">B_earth_body_x</span><span class="p">,</span> <span class="n">B_earth_body_y</span><span class="p">,</span> <span class="n">B_earth_body_z</span><span class="p">))</span> <span class="c1"># Shape (3, N)</span>

    <span class="n">B_earth_body_dot_x</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">B_earth_body_x</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="n">B_earth_body_dot_y</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">B_earth_body_y</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="n">B_earth_body_dot_z</span> <span class="o">=</span> <span class="n">fdm</span><span class="p">(</span><span class="n">B_earth_body_z</span><span class="p">)</span> <span class="o">/</span> <span class="n">dt</span>
    <span class="n">B_earth_body_dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">B_earth_body_dot_x</span><span class="p">,</span> <span class="n">B_earth_body_dot_y</span><span class="p">,</span> <span class="n">B_earth_body_dot_z</span><span class="p">))</span>

    <span class="n">c_p_rand</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cor_perm_mag</span>
    
    <span class="n">rand_i</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cor_ind_mag</span>
    <span class="n">c_i_rand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">rand_i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rand_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rand_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">rand_i</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rand_i</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rand_i</span><span class="p">[</span><span class="mi">4</span><span class="p">]],</span>
        <span class="p">[</span><span class="n">rand_i</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">rand_i</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">rand_i</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
    <span class="p">])</span>
    
    <span class="n">rand_e</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">cor_eddy_mag</span>
    <span class="n">c_e_rand</span> <span class="o">=</span> <span class="n">rand_e</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">igrf_field_ideal_bf</span> <span class="o">=</span> <span class="n">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">traj_ideal</span><span class="p">)</span> <span class="c1"># Pass the Traj object directly</span>
    <span class="n">aircraft_field_vector</span> <span class="o">=</span> <span class="n">get_tolles_lawson_aircraft_field_vector</span><span class="p">(</span>
        <span class="n">B_earth_body</span><span class="p">,</span>
        <span class="n">B_earth_body_dot</span><span class="p">,</span>
        <span class="n">c_p_rand</span><span class="p">,</span>
        <span class="n">c_i_rand</span><span class="p">,</span>
        <span class="n">c_e_rand</span><span class="p">,</span>
        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># placeholder for norm_flux_b</span>
        <span class="mf">0.0</span><span class="p">,</span>  <span class="c1"># placeholder for norm_flux_c</span>
        <span class="n">traj_ideal</span><span class="o">.</span><span class="n">Cnb</span><span class="p">,</span>  <span class="c1"># dcm_data</span>
        <span class="n">igrf_field_ideal_bf</span> <span class="c1"># igrf_bf</span>
        <span class="p">)</span>

    <span class="n">B_norm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">B_earth_body</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">B_norm</span><span class="p">[</span><span class="n">B_norm</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-9</span>
    <span class="n">unit_B_earth</span> <span class="o">=</span> <span class="n">B_earth_body</span> <span class="o">/</span> <span class="n">B_norm</span>
    <span class="n">aircraft_field_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">aircraft_field_vector</span> <span class="o">*</span> <span class="n">unit_B_earth</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">perturbed_total_field_vector</span> <span class="o">=</span> <span class="n">B_earth_body</span> <span class="o">+</span> <span class="n">aircraft_field_vector</span>
    <span class="n">mag_after_ac_interference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">perturbed_total_field_vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">mag_uc</span> <span class="o">=</span> <span class="n">mag_after_ac_interference</span> <span class="o">+</span> <span class="n">diurnal_effect</span>

    <span class="k">return</span> <span class="n">mag_uc</span><span class="p">,</span> <span class="n">aircraft_field_scalar</span><span class="p">,</span> <span class="n">diurnal_effect</span></div>



<div class="viewcode-block" id="create_flux">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_flux">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_flux</span><span class="p">(</span>
    <span class="n">path_or_lat</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Path</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]],</span>
    <span class="n">lon_or_mapV</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">MapV</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Can be MapV object</span>
    <span class="n">alt_or_itp</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">interp1d</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># Can be map path for MapV</span>
    <span class="n">itp_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">map_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">meas_var</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="c1"># Variance for each component</span>
    <span class="n">fogm_sigma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="c1"># FOGM std dev for each component</span>
    <span class="n">fogm_tau</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">600.0</span><span class="p">,</span> <span class="c1"># FOGM correlation time</span>
    <span class="n">dt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">map_resolution_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">200.0</span><span class="p">,</span>
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">default_map_id_override</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># New parameter</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MagV</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates compensated (clean) vector magnetometer measurements (MagV struct).</span>
<span class="sd">    Similar to create_mag_c but for vector data using MapV.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">itp_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">itp_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">map_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">map_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">map_val_x</span><span class="p">,</span> <span class="n">map_val_y</span><span class="p">,</span> <span class="n">map_val_z</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">num_points</span><span class="p">:</span> <span class="nb">int</span>
    
    <span class="c1"># This will hold the actual MapV object to use for getting values.</span>
    <span class="c1"># It can be passed directly (as lon_or_mapV), or loaded via path (alt_or_itp as str),</span>
    <span class="c1"># or loaded via default_map_id_override, or loaded via constants.DEFAULT_VECTOR_MAP_ID.</span>
    <span class="n">map_object_to_use</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MapV</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># This will hold the name/ID of the map if it needs to be loaded.</span>
    <span class="n">map_id_to_load</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon_or_mapV</span><span class="p">,</span> <span class="p">(</span><span class="n">_ActualMapS</span><span class="p">,</span> <span class="n">_ActualMapSd</span><span class="p">,</span> <span class="n">_ActualMapS3D</span><span class="p">,</span> <span class="n">MapV</span><span class="p">)):</span> <span class="c1"># Check if MapV object is directly passed</span>
        <span class="n">map_object_to_use</span> <span class="o">=</span> <span class="n">lon_or_mapV</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Using directly provided MapV object: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span> <span class="c1"># A map path/ID string is provided via alt_or_itp</span>
        <span class="n">map_id_to_load</span> <span class="o">=</span> <span class="n">alt_or_itp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Map path/ID provided via alt_or_itp: &#39;</span><span class="si">{</span><span class="n">map_id_to_load</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">default_map_id_override</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="c1"># An override ID is provided</span>
        <span class="n">map_id_to_load</span> <span class="o">=</span> <span class="n">default_map_id_override</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Using default_map_id_override: &#39;</span><span class="si">{</span><span class="n">map_id_to_load</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># Fallback to the global constant</span>
        <span class="n">map_id_to_load</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">DEFAULT_VECTOR_MAP_ID</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Using constants.DEFAULT_VECTOR_MAP_ID: &#39;</span><span class="si">{</span><span class="n">map_id_to_load</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="c1"># Load the map if an ID was determined and no map object was directly passed</span>
    <span class="k">if</span> <span class="n">map_object_to_use</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">map_id_to_load</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">current_map_kwargs</span> <span class="o">=</span> <span class="n">map_kwargs</span> <span class="k">if</span> <span class="n">map_kwargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Attempting to load map. Name: &#39;</span><span class="si">{</span><span class="n">map_id_to_load</span><span class="si">}</span><span class="s2">&#39;, Type: &#39;vector&#39;, kwargs: </span><span class="si">{</span><span class="n">current_map_kwargs</span><span class="si">}</span><span class="s2">, silent: </span><span class="si">{</span><span class="n">silent</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">map_object_to_use</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">map_id_to_load</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="s2">&quot;vector&quot;</span><span class="p">,</span> <span class="n">map_kwargs</span><span class="o">=</span><span class="n">current_map_kwargs</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">map_object_to_use</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load vector map: </span><span class="si">{</span><span class="n">map_id_to_load</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Successfully loaded map: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="p">)</span><span class="si">}</span><span class="s2"> using ID &#39;</span><span class="si">{</span><span class="n">map_id_to_load</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">map_object_to_use</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">):</span> <span class="c1"># Check if interpolator was passed as alt_or_itp</span>
         <span class="c1"># This case means no map object, no ID to load, and alt_or_itp is not an interpolator.</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;create_flux: Could not determine MapV object or a valid map ID to load, and no interpolator provided.&quot;</span><span class="p">)</span>


    <span class="c1"># Determine N and dt from path_or_lat</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_lat</span><span class="p">,</span> <span class="p">(</span><span class="n">Traj</span><span class="p">,</span> <span class="n">INS</span><span class="p">)):</span>
        <span class="n">path_data</span> <span class="o">=</span> <span class="n">path_or_lat</span>
        <span class="n">num_points</span> <span class="o">=</span> <span class="n">path_data</span><span class="o">.</span><span class="n">N</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">path_data</span><span class="o">.</span><span class="n">dt</span>
        <span class="n">lat_arr</span><span class="p">,</span> <span class="n">lon_arr</span><span class="p">,</span> <span class="n">alt_arr</span> <span class="o">=</span> <span class="n">path_data</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span> <span class="n">path_data</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span> <span class="n">path_data</span><span class="o">.</span><span class="n">alt</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path_or_lat</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span> <span class="c1"># lat, lon, alt arrays</span>
        <span class="n">lat_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">path_or_lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon_or_mapV</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">map_object_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">)):</span> <span class="c1"># if map object not set and alt_or_itp not interpolator</span>
                 <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If path_or_lat is lat array, lon_or_mapV (lon) and alt_or_itp (alt/interpolator) must be provided, or a map object determined.&quot;</span><span class="p">)</span>
        
        <span class="n">lon_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">lon_or_mapV</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lon_or_mapV</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span> <span class="k">else</span> <span class="kc">None</span> <span class="c1"># May be None if map_object_to_use is set</span>
        
        <span class="c1"># Handle alt_input: can be array, scalar, or taken from map if map_object_to_use is available</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
            <span class="n">alt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
            <span class="n">alt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">map_object_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">):</span> <span class="c1"># Use map&#39;s altitude if alt_or_itp is not alt data</span>
            <span class="n">alt_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">,</span> <span class="n">map_object_to_use</span><span class="o">.</span><span class="n">alt</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="o">.</span><span class="n">alt</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="nb">int</span><span class="p">))</span> <span class="k">else</span> <span class="n">map_object_to_use</span><span class="o">.</span><span class="n">alt</span>
        <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">):</span> <span class="c1"># If alt_or_itp is an interpolator, alt_arr might not be directly used for get_map_val</span>
            <span class="n">alt_arr</span> <span class="o">=</span> <span class="kc">None</span> <span class="c1"># Placeholder, actual altitude might be part of interpolator&#39;s input</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Altitude data (array/scalar) or a map with altitude attribute is required for array input.&quot;</span><span class="p">)</span>

        <span class="n">num_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lon_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_arr</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lat/lon arrays must have same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">alt_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alt_arr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">alt_arr</span><span class="p">):</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Lat/alt arrays must have same length.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dt must be provided if path_or_lat is an array.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;path_or_lat must be a Path object (Traj/INS) or latitude array.&quot;</span><span class="p">)</span>

    <span class="c1"># Get map values</span>
    <span class="k">if</span> <span class="n">map_object_to_use</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Getting map values from </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Ensure lon_arr and alt_arr are valid for get_map_val</span>
        <span class="n">_lon_for_getmap</span> <span class="o">=</span> <span class="n">lon_arr</span> <span class="k">if</span> <span class="n">lon_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">)</span> <span class="c1"># get_map_val might need some lon</span>
        <span class="n">_alt_for_getmap</span> <span class="o">=</span> <span class="n">alt_arr</span> <span class="k">if</span> <span class="n">alt_arr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">,</span> <span class="n">map_object_to_use</span><span class="o">.</span><span class="n">alt</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="p">,</span> <span class="s1">&#39;alt&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">lat_arr</span><span class="p">))</span>

        <span class="n">map_vals_tuple</span> <span class="o">=</span> <span class="n">get_map_val</span><span class="p">(</span><span class="n">map_object_to_use</span><span class="p">,</span> <span class="n">lat_arr</span><span class="p">,</span> <span class="n">_lon_for_getmap</span><span class="p">,</span> <span class="n">_alt_for_getmap</span><span class="p">,</span>
                                     <span class="n">return_interpolator</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">map_vals_tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">map_vals_tuple</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">map_val_x</span><span class="p">,</span> <span class="n">map_val_y</span><span class="p">,</span> <span class="n">map_val_z</span> <span class="o">=</span> <span class="n">map_vals_tuple</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;get_map_val with MapV did not return a 3-component tuple.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">alt_or_itp</span><span class="p">):</span> <span class="c1"># Use interpolator passed via alt_or_itp</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DEBUG_CREATE_FLUX: Using provided interpolator function.&quot;</span><span class="p">)</span>
        <span class="c1"># Assumes interpolator takes points (lat, lon, alt) and returns (vx, vy, vz)</span>
        <span class="c1"># This requires lat_arr, lon_arr, and alt_arr to be correctly set up for the interpolator.</span>
        <span class="k">if</span> <span class="n">lon_arr</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">alt_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;lon_arr and alt_arr must be available for interpolator.&quot;</span><span class="p">)</span>
        <span class="n">points_for_itp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">lat_arr</span><span class="p">,</span> <span class="n">lon_arr</span><span class="p">,</span> <span class="n">alt_arr</span><span class="p">))</span>
        <span class="n">map_val_x</span><span class="p">,</span> <span class="n">map_val_y</span><span class="p">,</span> <span class="n">map_val_z</span> <span class="o">=</span> <span class="n">alt_or_itp</span><span class="p">(</span><span class="n">points_for_itp</span><span class="p">)</span> <span class="c1"># Unpack directly</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Vector map components could not be determined (no map object and no interpolator).&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">map_val_x</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">map_val_y</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">map_val_z</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Vector map components (map_val_x, y, or z) are None before noise addition.&quot;</span><span class="p">)</span>

    <span class="c1"># Add FOGM noise</span>
    <span class="k">if</span> <span class="n">fogm_sigma</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">fogm_tau</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;dt required for FOGM noise.&quot;</span><span class="p">)</span>
        <span class="n">map_val_x</span> <span class="o">+=</span> <span class="n">generate_fogm_noise</span><span class="p">(</span><span class="n">fogm_sigma</span><span class="p">,</span> <span class="n">fogm_tau</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
        <span class="n">map_val_y</span> <span class="o">+=</span> <span class="n">generate_fogm_noise</span><span class="p">(</span><span class="n">fogm_sigma</span><span class="p">,</span> <span class="n">fogm_tau</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>
        <span class="n">map_val_z</span> <span class="o">+=</span> <span class="n">generate_fogm_noise</span><span class="p">(</span><span class="n">fogm_sigma</span><span class="p">,</span> <span class="n">fogm_tau</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_points</span><span class="p">)</span>

    <span class="c1"># Add measurement variance</span>
    <span class="k">if</span> <span class="n">meas_var</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">std_dev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">meas_var</span><span class="p">)</span>
        <span class="n">map_val_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev</span>
        <span class="n">map_val_y</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev</span>
        <span class="n">map_val_z</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_points</span><span class="p">)</span> <span class="o">*</span> <span class="n">std_dev</span>
        
    <span class="n">total_mag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">map_val_x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">map_val_y</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">map_val_z</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MagV</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">map_val_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">map_val_y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">map_val_z</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">total_mag</span><span class="p">)</span></div>



<div class="viewcode-block" id="create_dcm_internal">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_dcm_internal">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_dcm_internal</span><span class="p">(</span>
    <span class="n">roll</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">pitch</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">yaw</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="n">order</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;body2nav&#39;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Internal helper to create DCM matrix/matrices from Euler angles.</span>
<span class="sd">    Uses euler2dcm.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yaw</span><span class="p">,</span> <span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">euler2dcm</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pitch</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">yaw</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">roll</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">pitch</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">yaw</span><span class="o">.</span><span class="n">shape</span> <span class="ow">and</span> <span class="n">roll</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;If Euler angles are arrays, they must be 1D and have the same shape.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">euler2dcm</span><span class="p">(</span><span class="n">roll</span><span class="p">,</span> <span class="n">pitch</span><span class="p">,</span> <span class="n">yaw</span><span class="p">,</span> <span class="n">order</span><span class="p">)</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Euler angles must be all scalars or all 1D numpy arrays of the same length.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="calculate_imputed_TL_earth">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.calculate_imputed_TL_earth">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">calculate_imputed_TL_earth</span><span class="p">(</span>
    <span class="n">xyz</span><span class="p">:</span> <span class="n">XYZ0</span><span class="p">,</span> 
    <span class="n">coeffs_TL</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
    <span class="n">terms_A</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">Bt_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50000.0</span> 
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the imputed Earth&#39;s magnetic field (scalar) based on uncompensated</span>
<span class="sd">    magnetometer data and Tolles-Lawson coefficients.</span>
<span class="sd">    B_earth_imputed = B_uc - B_aircraft_TL_modelled</span>
<span class="sd">    Args:</span>
<span class="sd">        xyz: XYZ0 data structure containing uncompensated mag data and aircraft state.</span>
<span class="sd">        coeffs_TL: Array of Tolles-Lawson coefficients.</span>
<span class="sd">        terms_A: List of terms defining the structure of the Tolles-Lawson A matrix.</span>
<span class="sd">                 Defaults to [&#39;permanent&#39;, &#39;induced&#39;, &#39;eddy&#39;, &#39;bias&#39;].</span>
<span class="sd">        Bt_scale: Total field scaling factor used with coeffs_TL.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Imputed Earth&#39;s scalar magnetic field [nT].</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">terms_A</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">terms_A</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;permanent&#39;</span><span class="p">,</span> <span class="s1">&#39;induced&#39;</span><span class="p">,</span> <span class="s1">&#39;eddy&#39;</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">]</span> 

    <span class="n">mag_uc</span> <span class="o">=</span> <span class="n">xyz</span><span class="o">.</span><span class="n">mag_1_uc</span>
    
    <span class="n">igrf_vec_body</span> <span class="o">=</span> <span class="n">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">norm_igrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_xyz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">Bx_earth</span><span class="p">,</span> <span class="n">By_earth</span><span class="p">,</span> <span class="n">Bz_earth</span> <span class="o">=</span> <span class="n">igrf_vec_body</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span> <span class="n">igrf_vec_body</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span> <span class="n">igrf_vec_body</span><span class="p">[</span><span class="mi">2</span><span class="p">,:]</span>

    <span class="n">A_TL</span> <span class="o">=</span> <span class="n">create_tolles_lawson_A_matrix</span><span class="p">(</span><span class="n">Bx_earth</span><span class="p">,</span> <span class="n">By_earth</span><span class="p">,</span> <span class="n">Bz_earth</span><span class="p">,</span> <span class="n">terms</span><span class="o">=</span><span class="n">terms_A</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">xyz</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

    <span class="n">B_ac_scalar_model</span> <span class="o">=</span> <span class="n">A_TL</span> <span class="o">@</span> <span class="n">coeffs_TL</span> 
    
    <span class="n">mag_earth_imputed</span> <span class="o">=</span> <span class="n">mag_uc</span> <span class="o">-</span> <span class="n">B_ac_scalar_model</span>
    
    <span class="k">return</span> <span class="n">mag_earth_imputed</span></div>



<div class="viewcode-block" id="create_informed_xyz">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_informed_xyz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_informed_xyz</span><span class="p">(</span>
    <span class="n">xyz_file</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">map_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">map_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>   
    <span class="n">map_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;scalar&quot;</span><span class="p">,</span>       
    <span class="n">flight_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">comp_coeffs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
    <span class="n">comp_terms_A</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">comp_Bt_scale</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">50000.0</span><span class="p">,</span>
    <span class="n">force_recalc_igrf</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">force_recalc_mag_c</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XYZ0</span><span class="p">:</span> 
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads an XYZ data file (text or HDF5) and enriches it with map data,</span>
<span class="sd">    IGRF data, and potentially compensated magnetometer data if coefficients are provided.</span>

<span class="sd">    Args:</span>
<span class="sd">        xyz_file: Path to the XYZ data file.</span>
<span class="sd">        map_file: Optional path to a map file (e.g., .h5).</span>
<span class="sd">        map_id: Optional map identifier (e.g., &quot;namad&quot;) if map_file is not given.</span>
<span class="sd">        map_type: Type of map (&quot;scalar&quot; or &quot;vector&quot;), relevant if loading map.</span>
<span class="sd">        flight_info: Dictionary to set/override &#39;flight&#39;, &#39;line&#39;, &#39;year&#39;, &#39;doy&#39;.</span>
<span class="sd">                     Example: {&#39;flight&#39;: 101, &#39;year&#39;: 2022}</span>
<span class="sd">        comp_coeffs: Optional Tolles-Lawson coefficients to calculate mag_1_c.</span>
<span class="sd">        comp_terms_A: Terms for TL A-matrix if comp_coeffs are used.</span>
<span class="sd">        comp_Bt_scale: Bt_scale for TL if comp_coeffs are used.</span>
<span class="sd">        force_recalc_igrf: If true, recalculate IGRF even if present.</span>
<span class="sd">        force_recalc_mag_c: If true and comp_coeffs given, recalc mag_1_c.</span>
<span class="sd">        silent: Suppress print statements.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An XYZ0 (or similar) data object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;XYZ file not found: </span><span class="si">{</span><span class="n">xyz_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">xyz_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.h5&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">xyz_data</span> <span class="o">=</span> <span class="n">h5_to_xyz0</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">)</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loaded base data from HDF5: </span><span class="si">{</span><span class="n">xyz_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not load base XYZ data from HDF5 file </span><span class="si">{</span><span class="n">xyz_file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Reading from non-HDF5 XYZ files into full structure is not yet fully implemented here.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">flight_info</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">flight_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span><span class="n">key</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">current_array</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="n">current_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">value</span> 
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in XYZ data.&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Could not update &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span> 
                 <span class="nb">setattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                 <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Updated &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; in XYZ data.&quot;</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">force_recalc_igrf</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;igrf&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">igrf</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">igrf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating IGRF field...&quot;</span><span class="p">)</span>
        <span class="n">igrf_vec_body</span> <span class="o">=</span> <span class="n">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">norm_igrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_xyz</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">xyz_data</span><span class="o">.</span><span class="n">igrf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">igrf_vec_body</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;mag_map&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">selected_map_source</span> <span class="o">=</span> <span class="n">map_file</span> <span class="k">if</span> <span class="n">map_file</span> <span class="k">else</span> <span class="n">map_id</span>
        <span class="k">if</span> <span class="n">selected_map_source</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating map values from source: </span><span class="si">{</span><span class="n">selected_map_source</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">map_type</span> <span class="o">==</span> <span class="s2">&quot;scalar&quot;</span><span class="p">:</span>
                <span class="n">actual_map_obj</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">selected_map_source</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="s2">&quot;scalar&quot;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
                <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_map</span> <span class="o">=</span> <span class="n">create_mag_c</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="n">actual_map_obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> 
                                                <span class="n">meas_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fogm_sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Vector map data population to a specific field not implemented in this simplified version.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No map source provided for &#39;mag_map&#39; field, skipping.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">comp_coeffs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">force_recalc_mag_c</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;mag_1_c&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Calculating compensated mag data (mag_1_c) using provided coefficients...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;mag_1_uc&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_uc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;mag_1_uc is required in XYZ data to calculate mag_1_c with coefficients.&quot;</span><span class="p">)</span>
            
            <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="o">=</span> <span class="n">calculate_imputed_TL_earth</span><span class="p">(</span>
                <span class="n">xyz_data</span><span class="p">,</span> <span class="n">comp_coeffs</span><span class="p">,</span> <span class="n">comp_terms_A</span><span class="p">,</span> <span class="n">comp_Bt_scale</span>
            <span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;mag_1_c&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;mag_map&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using &#39;mag_map&#39; as &#39;mag_1_c&#39; (compensated data proxy).&quot;</span><span class="p">)</span>
            <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_map</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">map_file</span> <span class="ow">or</span> <span class="n">map_id</span> <span class="p">:</span> 
             <span class="n">actual_map_obj</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">map_file</span> <span class="k">if</span> <span class="n">map_file</span> <span class="k">else</span> <span class="n">map_id</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="s2">&quot;scalar&quot;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
             <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Calculating &#39;mag_1_c&#39; from map </span><span class="si">{</span><span class="n">map_file</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">map_file</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">map_id</span><span class="si">}</span><span class="s2"> as clean data proxy.&quot;</span><span class="p">)</span>
             <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="o">=</span> <span class="n">create_mag_c</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="n">actual_map_obj</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                             <span class="n">meas_var</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">fogm_sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>


    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;flux_a&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">flux_a</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;igrf&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">igrf</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
            <span class="n">igrf_vec_body_for_flux</span> <span class="o">=</span> <span class="n">get_igrf_magnetic_field</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="s1">&#39;body&#39;</span><span class="p">,</span> <span class="n">norm_igrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">check_xyz</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">xyz_data</span><span class="o">.</span><span class="n">flux_a</span> <span class="o">=</span> <span class="n">MagV</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">igrf_vec_body_for_flux</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span>
                                   <span class="n">y</span><span class="o">=</span><span class="n">igrf_vec_body_for_flux</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span>
                                   <span class="n">z</span><span class="o">=</span><span class="n">igrf_vec_body_for_flux</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span>
                                   <span class="n">t</span><span class="o">=</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">igrf</span><span class="p">)</span> 
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Populated flux_a using IGRF body vector components.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: flux_a is missing and could not be derived from IGRF.&quot;</span><span class="p">)</span>
            <span class="n">dummy_field</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">N</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span><span class="s1">&#39;traj&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">xyz_data</span><span class="o">.</span><span class="n">flux_a</span> <span class="o">=</span> <span class="n">MagV</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dummy_field</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">dummy_field</span><span class="p">,</span><span class="n">z</span><span class="o">=</span><span class="n">dummy_field</span><span class="p">,</span><span class="n">t</span><span class="o">=</span><span class="n">dummy_field</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;traj&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">):</span>
        <span class="n">default_len</span> <span class="o">=</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">N</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;flight&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;doy&#39;</span><span class="p">,</span> <span class="s1">&#39;diurnal&#39;</span><span class="p">,</span> <span class="s1">&#39;igrf&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_1_c&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_1_uc&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: XYZ field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; missing. Initializing with zeros/defaults.&quot;</span><span class="p">)</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">default_len</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">xyz_data</span></div>



<span class="c1"># --- Filename generation ---</span>
<div class="viewcode-block" id="xyz_file_name">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.xyz_file_name">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">xyz_file_name</span><span class="p">(</span>
    <span class="n">project</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">flight</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
    <span class="n">line</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">xyz_type</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;xyz&quot;</span><span class="p">,</span> <span class="c1"># &quot;xyz&quot;, &quot;xyz0&quot;, &quot;xyz1&quot;, &quot;xyz20&quot;, &quot;xyz21&quot;</span>
    <span class="n">ext</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.h5&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generates a standardized XYZ file name.</span>
<span class="sd">    Example: project_Flt1003_L10.xyz0.h5</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">project</span><span class="si">}</span><span class="s2">_Flt</span><span class="si">{</span><span class="n">flight</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">line</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;_L</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">name</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;.</span><span class="si">{</span><span class="n">xyz_type</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">add_extension</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">name</span></div>


<span class="c1"># --- XYZ File I/O ---</span>
<div class="viewcode-block" id="write_xyz">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.write_xyz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">write_xyz</span><span class="p">(</span>
    <span class="n">xyz_data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">XYZ0</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> 
    <span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Writes an XYZ data structure to an HDF5 file.</span>
<span class="sd">    This is a basic example; a full implementation would handle all XYZ types</span>
<span class="sd">    and their specific fields. For now, focuses on XYZ0-like structure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">add_extension</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;.h5&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> already exists. Use overwrite=True to replace.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;w&quot;</span> <span class="k">if</span> <span class="n">overwrite</span> <span class="k">else</span> <span class="s2">&quot;w-&quot;</span> 

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;info&#39;</span><span class="p">):</span>
                <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;traj&#39;</span><span class="p">):</span>
                <span class="n">traj_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;traj&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">traj_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                         <span class="n">traj_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>


            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;ins&#39;</span><span class="p">):</span>
                <span class="n">ins_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;ins&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">ins</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">ins_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ins_group</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;flux_a&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">xyz_data</span><span class="o">.</span><span class="n">flux_a</span><span class="p">,</span> <span class="n">MagV</span><span class="p">):</span>
                <span class="n">flux_a_group</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s2">&quot;flux_a&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">xyz_data</span><span class="o">.</span><span class="n">flux_a</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                     <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">flux_a_group</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>

            <span class="n">direct_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flight&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;doy&#39;</span><span class="p">,</span> <span class="s1">&#39;diurnal&#39;</span><span class="p">,</span> <span class="s1">&#39;igrf&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_1_c&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_1_uc&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">direct_fields</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">field_name</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> 
                        <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;XYZ data successfully written to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error writing XYZ data to </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;w-&quot;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">pass</span> 
        <span class="k">raise</span></div>



<div class="viewcode-block" id="read_xyz_file">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.read_xyz_file">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">read_xyz_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reads a CSV-like XYZ file into a pandas DataFrame.</span>
<span class="sd">    This is a basic reader; column names and types might need adjustment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;XYZ text file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="n">delimiter</span><span class="p">,</span> <span class="n">skipinitialspace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading XYZ text file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="h5_to_xyz0">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.h5_to_xyz0">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">h5_to_xyz0</span><span class="p">(</span><span class="n">file_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XYZ0</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Loads data from an HDF5 file into an XYZ0 structure.</span>
<span class="sd">    This is a simplified loader, assuming a specific HDF5 structure created by `write_xyz` or similar.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;HDF5 file not found: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">traj_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">ins_data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">flux_a_data</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s2">&quot;Loaded from HDF5&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;traj&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;traj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;traj&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][:]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;traj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">traj_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;traj&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;ins&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;ins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">ins_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;ins&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][:]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;ins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">ins_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;ins&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;flux_a&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;flux_a&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> <span class="n">flux_a_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s2">&quot;flux_a&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">][:]</span>
        
        <span class="n">direct_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flight&#39;</span><span class="p">,</span> <span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="s1">&#39;doy&#39;</span><span class="p">,</span> <span class="s1">&#39;diurnal&#39;</span><span class="p">,</span> <span class="s1">&#39;igrf&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_1_c&#39;</span><span class="p">,</span> <span class="s1">&#39;mag_1_uc&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">direct_fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="n">field_name</span><span class="p">][:]</span>
            <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span> <span class="n">data_dict</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>


    <span class="n">traj_obj</span> <span class="o">=</span> <span class="n">Traj</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">Traj</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">})</span>
    
    <span class="n">ins_fields_from_traj</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">traj_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">INS</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="ow">and</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ins_data</span><span class="p">}</span>
    <span class="n">ins_obj</span> <span class="o">=</span> <span class="n">INS</span><span class="p">(</span><span class="o">**</span><span class="n">ins_fields_from_traj</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ins_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">INS</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">})</span>

    <span class="n">flux_a_obj</span> <span class="o">=</span> <span class="n">MagV</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">flux_a_data</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">MagV</span><span class="o">.</span><span class="vm">__annotations__</span><span class="p">})</span>

    <span class="n">xyz_data_obj</span> <span class="o">=</span> <span class="n">XYZ0</span><span class="p">(</span>
        <span class="n">info</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s2">&quot;Info missing&quot;</span><span class="p">),</span>
        <span class="n">traj</span><span class="o">=</span><span class="n">traj_obj</span><span class="p">,</span>
        <span class="n">ins</span><span class="o">=</span><span class="n">ins_obj</span><span class="p">,</span>
        <span class="n">flux_a</span><span class="o">=</span><span class="n">flux_a_obj</span><span class="p">,</span>
        <span class="n">flight</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;flight&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">line</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">year</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">doy</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;doy&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">diurnal</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;diurnal&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">igrf</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;igrf&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">mag_1_c</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mag_1_c&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])),</span>
        <span class="n">mag_1_uc</span><span class="o">=</span><span class="n">data_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mag_1_uc&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]))</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Data loaded into XYZ0 structure from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xyz_data_obj</span></div>



<div class="viewcode-block" id="create_xyz">
<a class="viewcode-back" href="../../api_reference.html#magnavpy.create_xyz.create_xyz">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">create_xyz</span><span class="p">(</span>
    <span class="n">xyz_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">map_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">map_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1000.0</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">,</span> <span class="n">v</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">68.0</span><span class="p">,</span> 
    <span class="n">flight_info</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">comp_coeffs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">silent</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span> 
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">XYZ0</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Master function to create or load and inform XYZ data.</span>
<span class="sd">    - If xyz_file is provided, it attempts to load and enrich it.</span>
<span class="sd">    - If xyz_file is None, it generates new data using create_xyz0 and other params.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">xyz_file</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">xyz_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Specified xyz_file </span><span class="si">{</span><span class="n">xyz_file</span><span class="si">}</span><span class="s2"> not found for loading.&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">create_informed_xyz</span><span class="p">(</span>
            <span class="n">xyz_file</span><span class="p">,</span>
            <span class="n">map_file</span><span class="o">=</span><span class="n">map_file</span><span class="p">,</span>
            <span class="n">map_id</span><span class="o">=</span><span class="n">map_id</span><span class="p">,</span>
            <span class="n">flight_info</span><span class="o">=</span><span class="n">flight_info</span><span class="p">,</span>
            <span class="n">comp_coeffs</span><span class="o">=</span><span class="n">comp_coeffs</span><span class="p">,</span>
            <span class="n">silent</span><span class="o">=</span><span class="n">silent</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No xyz_file provided, generating new data using create_xyz0...&quot;</span><span class="p">)</span>
        
        <span class="n">mapS_for_create</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">map_file</span><span class="p">:</span>
            <span class="n">mapS_for_create</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">map_file</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="s2">&quot;scalar&quot;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">map_id</span><span class="p">:</span>
            <span class="n">mapS_for_create</span> <span class="o">=</span> <span class="n">get_map</span><span class="p">(</span><span class="n">map_id</span><span class="p">,</span> <span class="n">map_type</span><span class="o">=</span><span class="s2">&quot;scalar&quot;</span><span class="p">,</span> <span class="n">silent</span><span class="o">=</span><span class="n">silent</span><span class="p">)</span>
            
        <span class="n">xyz_data</span> <span class="o">=</span> <span class="n">create_xyz0</span><span class="p">(</span>
            <span class="n">mapS</span><span class="o">=</span><span class="n">mapS_for_create</span><span class="p">,</span> 
            <span class="n">alt</span><span class="o">=</span><span class="n">alt</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="n">t</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="n">silent</span><span class="o">=</span><span class="n">silent</span>
        <span class="p">)</span>
        
        <span class="k">if</span> <span class="n">comp_coeffs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">xyz_data</span><span class="p">,</span> <span class="s1">&#39;mag_1_uc&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">silent</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Applying compensation coefficients to newly generated data...&quot;</span><span class="p">)</span>
            <span class="n">xyz_data</span><span class="o">.</span><span class="n">mag_1_c</span> <span class="o">=</span> <span class="n">calculate_imputed_TL_earth</span><span class="p">(</span>
                <span class="n">xyz_data</span><span class="p">,</span> <span class="n">comp_coeffs</span> 
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">xyz_data</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
    <div class="clearer"></div>
  </div>
    <div class="footer">
      &#169;2020-2023, Original MagNav.jl Authors; 2024-2025, Manas Pandey.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.2.3</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>